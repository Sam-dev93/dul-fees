<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#10A37F">
<title>Student Fees Tracker</title>
<link rel="manifest" href="fees-manifest.json">
<link rel="apple-touch-icon" href="fees-icon-192.png">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- PDF Generation Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<!-- SHEETJS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    :root {
        --primary: #10A37F;
        --primary-dark: #0D7A5F;
        --primary-light: #D1FAE5;
        --success: #34C759;
        --warning: #FF9500;
        --danger: #FF3B30;
        --info: #007AFF;
        --background: #000000;
        --card-bg: #1C1C1E;
        --card-bg-elevated: #2C2C2E;
        --text-primary: #FFFFFF;
        --text-secondary: #98989D;
        --border: #38383A;
        --shadow: rgba(0, 0, 0, 0.3);
        --term1-color: #34C759;
        --term2-color: #AF52DE;
    }

    @media (prefers-color-scheme: light) {
        :root {
            --background: #F2F2F7;
            --card-bg: #FFFFFF;
            --card-bg-elevated: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --shadow: rgba(0, 0, 0, 0.08);
        }
    }

    html {
        height: 100vh;
        height: -webkit-fill-available;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
        background: var(--background);
        color: var(--text-primary);
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
        position: relative;
    }

    .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        height: -webkit-fill-available;
        position: relative;
    }

    .header {
        background: var(--card-bg);
        padding: calc(env(safe-area-inset-top, 0px) + 16px) 24px 24px;
        position: relative;
        z-index: 100;
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        background: rgba(28, 28, 30, 0.72);
        border-bottom: 0.5px solid var(--border);
        flex-shrink: 0;
    }

    @media (prefers-color-scheme: light) {
        .header {
            background: rgba(242, 242, 247, 0.8);
        }
    }

    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header h1 {
        font-size: 38px;
        font-weight: 700;
        letter-spacing: -1px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .year-badge {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        cursor: pointer;
        transition: all 0.2s;
    }

    .year-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(16, 163, 127, 0.4);
    }

    .nav-tabs {
        background: var(--card-bg);
        border-bottom: 0.5px solid var(--border);
        padding: 0 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: sticky;
        top: 0;
        z-index: 90;
        min-height: 60px;
        display: flex;
        align-items: center;
    }

    .nav-tabs-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        gap: 4px;
        min-width: max-content;
        flex: 1;
    }

    .nav-tab {
        padding: 12px 16px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        border-radius: 12px 12px 0 0;
        transition: all 0.3s;
        white-space: nowrap;
        font-size: 16px;
        position: relative;
        flex-shrink: 0;
    }

    .nav-tab.active {
        color: var(--primary);
        background: var(--card-bg-elevated);
        transform: translateY(-2px);
    }

    .nav-tab.term1.active {
        color: var(--term1-color);
    }

    .nav-tab.term2.active {
        color: var(--term2-color);
    }

    .view-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 24px;
        min-height: 0;
    }

    .main-content {
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }

    .view {
        display: none;
    }

    .view.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg-elevated) 100%);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 4px 16px var(--shadow);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .stat-card.total::before { background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); }
    .stat-card.paid::before { background: linear-gradient(180deg, var(--success) 0%, #28A745 100%); }
    .stat-card.partial::before { background: linear-gradient(180deg, var(--warning) 0%, #E67E22 100%); }
    .stat-card.outstanding::before { background: linear-gradient(180deg, var(--danger) 0%, #DC3545 100%); }

    .stat-card .label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 36px;
        font-weight: 700;
        letter-spacing: -1px;
        margin-bottom: 8px;
    }

    .stat-card .description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .stat-card.total .value { color: var(--primary); }
    .stat-card.paid .value { color: var(--success); }
    .stat-card.partial .value { color: var(--warning); }
    .stat-card.outstanding .value { color: var(--danger); }

    .controls {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-box {
        flex: 1;
        min-width: 320px;
        padding: 16px 20px;
        border: 1.5px solid var(--border);
        border-radius: 16px;
        background: var(--card-bg-elevated);
        color: var(--text-primary);
        font-size: 16px;
        font-family: inherit;
        transition: all 0.2s;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--card-bg);
        box-shadow: 0 0 0 4px rgba(16, 163, 127, 0.1);
    }

    .filter-select {
        padding: 16px 20px;
        border: 1.5px solid var(--border);
        border-radius: 16px;
        background: var(--card-bg-elevated);
        color: var(--text-primary);
        font-size: 16px;
        font-family: inherit;
        transition: all 0.2s;
        min-width: 180px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--card-bg);
        box-shadow: 0 0 0 4px rgba(16, 163, 127, 0.1);
    }

    .btn {
        padding: 16px 24px;
        border: none;
        border-radius: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-family: inherit;
    }

    .btn:active {
        transform: scale(0.98);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 16px rgba(16, 163, 127, 0.3);
    }

    .btn-secondary {
        background: var(--card-bg-elevated);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
        margin: 0 2px;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
        border: 1px solid var(--danger);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
        border: 1px solid var(--warning);
    }

    .btn-info {
        background: var(--info);
        color: white;
        border: 1px solid var(--info);
    }

    .btn-success {
        background: var(--success);
        color: white;
        border: 1px solid var(--success);
    }

    /* Bulk Actions */
    .bulk-actions {
        display: none;
        background: var(--card-bg-elevated);
        border: 2px solid var(--primary);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 16px;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 16px rgba(16, 163, 127, 0.2);
    }

    .bulk-actions.show {
        display: flex;
    }

    .bulk-actions-text {
        font-weight: 600;
        color: var(--primary);
        flex: 1;
    }

    .bulk-actions-buttons {
        display: flex;
        gap: 8px;
    }

    .bulk-actions .btn {
        padding: 8px 16px;
        font-size: 14px;
    }

    .selection-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 16px;
    }

    .selection-controls .btn {
        padding: 8px 12px;
        font-size: 12px;
    }

    .table-container {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 4px 16px var(--shadow);
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1500px;
    }

    .table th,
    .table td {
        padding: 16px 20px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
    }

    .table th {
        background: var(--card-bg-elevated);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table th:first-child,
    .table td:first-child {
        width: 60px;
        text-align: center;
        padding: 16px 10px;
    }

    .table tr:hover {
        background: var(--card-bg-elevated);
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .table td:last-child {
        width: 280px;
        min-width: 280px;
    }

    .student-checkbox {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
    }

    .select-all-checkbox {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
    }

    .payment-status {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        gap: 6px;
    }

    .payment-status.paid {
        background: rgba(52, 199, 89, 0.2);
        color: var(--success);
        border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .payment-status.partial {
        background: rgba(255, 149, 0, 0.2);
        color: var(--warning);
        border: 1px solid rgba(255, 149, 0, 0.3);
    }

    .payment-status.unpaid {
        background: rgba(255, 59, 48, 0.2);
        color: var(--danger);
        border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .payment-status.left {
        background: rgba(128, 128, 128, 0.2);
        color: #808080;
        border: 1px solid rgba(128, 128, 128, 0.3);
    }

    .payment-status .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        animation: fadeIn 0.3s;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal.active {
        display: flex !important;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 24px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin: auto;
    }

    .view-modal-content {
        max-width: 1100px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(50px) scale(0.95); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .close-btn {
        background: var(--card-bg-elevated);
        border: 1px solid var(--border);
        width: 36px;
        height: 36px;
        border-radius: 18px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.2s;
    }

    .close-btn:active {
        transform: scale(0.9);
    }

    .form-group {
        margin-bottom: 14px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-secondary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid var(--border);
        border-radius: 10px;
        background: var(--card-bg-elevated);
        color: var(--text-primary);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
    }

    .form-textarea {
        min-height: 60px;
        resize: vertical;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--card-bg);
        box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .form-grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .section {
        background: var(--card-bg-elevated);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
    }

    .section-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text-primary);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    .status-options {
        display: flex;
        gap: 24px;
        align-items: center;
    }

    .status-option {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-option input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .status-option label {
        font-size: 14px;
        color: var(--text-primary);
        cursor: pointer;
    }

    .payment-row {
        display: grid;
        grid-template-columns: 80px 100px 140px 120px 40px;
        gap: 12px;
        align-items: end;
        padding: 12px;
        background: var(--card-bg);
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid var(--border);
    }

    .payment-row .form-group {
        margin-bottom: 0;
    }

    .payment-row .form-input,
    .payment-row .form-select {
        padding: 10px 12px;
        font-size: 14px;
    }

    .payment-row .form-label {
        font-size: 11px;
        margin-bottom: 4px;
    }

    .delete-payment {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .delete-payment:hover {
        background: #dc2626;
    }

    .add-payment-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        margin-top: 8px;
    }

    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--background);
        z-index: 3000;
        text-align: center;
        padding: 80px 20px;
        color: var(--text-secondary);
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-secondary);
    }

    .empty-state .icon {
        font-size: 60px;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .empty-state .title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .empty-state .subtitle {
        font-size: 16px;
        line-height: 1.5;
    }

    .fab {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 24px);
        right: 24px;
        width: 60px;
        height: 60px;
        border-radius: 30px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        box-shadow: 0 8px 24px rgba(16, 163, 127, 0.4);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        transition: transform 0.2s;
    }

    .fab:active {
        transform: scale(0.92);
    }

    .fab svg {
        width: 28px;
        height: 28px;
        stroke: white;
    }

    .sync-status {
        position: fixed;
        top: calc(env(safe-area-inset-top, 0px) + 12px);
        right: 20px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 5px;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .sync-status.syncing { color: var(--warning); }
    .sync-status.synced { color: var(--success); }
    .sync-status.offline { color: var(--text-secondary); }

    .sync-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .sync-dot.syncing {
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .file-upload-area {
        border: 2px dashed var(--border);
        border-radius: 16px;
        padding: 32px;
        text-align: center;
        background: var(--card-bg-elevated);
        transition: all 0.3s;
        cursor: pointer;
    }

    .file-upload-area:hover {
        border-color: var(--primary);
        background: rgba(16, 163, 127, 0.05);
    }

    .file-upload-area.dragover {
        border-color: var(--primary);
        background: rgba(16, 163, 127, 0.1);
    }

    .file-upload-input {
        display: none;
    }

    /* Student View Modal Styles */
    .student-overview {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .student-info-card {
        background: var(--card-bg-elevated);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border);
    }

    .student-summary-card {
        background: var(--card-bg-elevated);
        border: 2px solid var(--primary);
        border-radius: 16px;
        padding: 24px;
        color: var(--text-primary);
        text-align: center;
    }

    .student-name {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text-primary);
    }

    .student-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .detail-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .summary-amount {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .summary-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 16px;
    }

    .summary-breakdown {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        text-align: left;
    }

    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
    }

    .payments-history {
        background: var(--card-bg-elevated);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border);
    }

    .payments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .payments-table {
        width: 100%;
        border-collapse: collapse;
    }

    .payments-table th,
    .payments-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .payments-table th {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .payments-table tr:last-child td {
        border-bottom: none;
    }

    .payment-method-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        background: var(--card-bg);
        color: var(--text-secondary);
        border: 1px solid var(--border);
    }

    .no-payments {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    /* Action buttons styles */
    .action-buttons {
        display: flex;
        gap: 4px;
        flex-wrap: nowrap;
        overflow-x: auto;
        justify-content: flex-start;
        align-items: center;
    }

    .action-buttons .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
        margin: 0;
        white-space: nowrap;
        flex-shrink: 0;
        min-width: auto;
    }

    /* Ensure buttons stay in one line on mobile */
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: row !important;
            gap: 2px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .action-buttons .btn-sm {
            padding: 6px 8px;
            font-size: 11px;
            min-width: 50px;
            text-align: center;
        }
        
        .table td:last-child {
            width: 240px;
            min-width: 240px;
            padding: 8px;
        }
    }

    /* For very small screens */
    @media (max-width: 480px) {
        .action-buttons .btn-sm {
            padding: 4px 6px;
            font-size: 10px;
            min-width: 45px;
        }
        
        .table td:last-child {
            width: 200px;
            min-width: 200px;
        }
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .modal-content {
            padding: 20px;
            margin: 10px;
            max-height: 95vh;
        }

        .form-grid-3 {
            grid-template-columns: 1fr;
        }

        .form-grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-grid-2 {
            grid-template-columns: 1fr;
        }

        .payment-row {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .status-options {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .header {
            padding: calc(env(safe-area-inset-top, 0px) + 12px) 16px 16px;
        }

        .header h1 {
            font-size: 28px;
        }

        .view-content {
            padding: 16px;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            padding: 16px;
        }

        .stat-card .value {
            font-size: 24px;
        }

        .controls {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .search-box,
        .filter-select {
            min-width: auto;
        }

        .table th,
        .table td {
            padding: 12px 16px;
            font-size: 14px;
        }

        .fab {
            bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
            right: 16px;
            width: 56px;
            height: 56px;
        }

        .student-overview {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .student-details {
            grid-template-columns: 1fr;
        }

        .summary-breakdown {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
            gap: 2px;
        }

        .btn-sm {
            padding: 6px 8px;
            font-size: 11px;
        }

        .table td:last-child {
            width: auto;
            min-width: auto;
        }

        .bulk-actions {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .bulk-actions-buttons {
            justify-content: center;
        }

        .selection-controls {
            flex-wrap: wrap;
        }
    }

    /* PDF Export Button Styling */
    .pdf-export-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .pdf-export-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg-elevated) 100%);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border);
        box-shadow: 0 4px 16px var(--shadow);
    }

    .pdf-export-card h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .pdf-export-card p {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .pdf-btn {
        width: 100%;
        padding: 14px 20px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 15px;
        font-family: inherit;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 16px rgba(16, 163, 127, 0.3);
    }

    .pdf-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 163, 127, 0.4);
    }

    .pdf-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .pdf-loading {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
    }

    /* Add this to your existing styles */
    .format-option:has(input:checked) {
        border-color: var(--primary) !important;
        background: rgba(16, 163, 127, 0.1) !important;
    }

    .format-option:hover {
        border-color: var(--primary);
        transform: translateY(-1px);
    }
</style>
</head>
<body>
<div class="app-container">
    <div id="appLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div style="color: var(--text-primary); font-size: 18px; font-weight: 600;">Loading student data...</div>
        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">Please wait...</div>
    </div>

    <div id="syncStatus" class="sync-status offline">
        <div class="sync-dot"></div>
        <span>Offline</span>
    </div>

    <header class="header">
        <div class="header-content">
            <div>
                <h1>DUL Student Fees</h1>
                <div style="font-size: 17px; color: var(--text-secondary); font-weight: 500;">Fee Management System</div>
            </div>
            <div class="year-badge" onclick="showYearSelector()" id="currentYearBadge">2025-2026</div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="nav-tabs-inner">
            <button class="nav-tab term1 active" onclick="switchView('term1')">Term 1</button>
            <button class="nav-tab term2" onclick="switchView('term2')">Term 2</button>
            <button class="nav-tab" onclick="switchView('overview')">Overview</button>
            <button class="nav-tab" onclick="switchView('reports')">Reports</button>
            <button class="nav-tab" onclick="switchView('analytics')">Analytics</button>
        </div>
    </nav>

    <div class="view-content">
        <main class="main-content">
            <!-- Term 1 View -->
            <div id="term1View" class="view active">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="label">Total Students</div>
                        <div class="value" id="term1TotalStudents">0</div>
                        <div class="description">Enrolled in Term 1</div>
                    </div>
                    <div class="stat-card paid">
                        <div class="label">Fully Paid</div>
                        <div class="value" id="term1FullyPaid">0</div>
                        <div class="description">No outstanding balance</div>
                    </div>
                    <div class="stat-card partial">
                        <div class="label">Partially Paid</div>
                        <div class="value" id="term1PartiallyPaid">0</div>
                        <div class="description">Some payments made</div>
                    </div>
                    <div class="stat-card outstanding">
                        <div class="label">Outstanding</div>
                        <div class="value" id="term1Outstanding">Â£0</div>
                        <div class="description">Total amount due</div>
                    </div>
                </div>

                <div class="controls">
                    <input type="text" class="search-box" id="term1Search" placeholder="Search students...">
                    <select class="filter-select" id="term1Filter" onchange="applyFilter('term1')">
                        <option value="all">All Students</option>
                        <option value="paid">Fully Paid</option>
                        <option value="partial">Partially Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="active">Active Students</option>
                        <option value="left">Left Students</option>
                        <option value="outstanding">Outstanding Only</option>
                        <option value="">-- Year Groups --</option>
                        <option value="year7">Year 7</option>
                        <option value="year8">Year 8</option>
                        <option value="year9">Year 9</option>
                        <option value="year10">Year 10</option>
                        <option value="year11">Year 11</option>
                        <option value="year16+">16+</option>
                        <option value="year18+">18+</option>
                        <option value="year19+">19+</option>
                    </select>
                </div>

                <!-- Selection Controls -->
                <div class="selection-controls">
                    <button class="btn btn-secondary btn-sm" onclick="selectAllStudents('term1', 'visible')">Select All Visible</button>
                    <button class="btn btn-secondary btn-sm" onclick="deselectAllStudents('term1')">Clear Selection</button>
                    <span style="color: var(--text-secondary); font-size: 14px; margin-left: 16px;">
                        <span id="term1SelectedDisplay">0</span> selected
                    </span>
                </div>

                <!-- Bulk Actions Bar -->
                <div class="bulk-actions" id="term1BulkActions">
                    <div class="bulk-actions-text">
                        <span id="term1SelectedCount">0</span> students selected
                    </div>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-danger" onclick="bulkDeleteStudents('term1')">Delete Selected</button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" class="select-all-checkbox" id="term1SelectAll" onchange="toggleSelectAll('term1')">
                                    </th>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>DOB</th>
                                    <th>Year</th>
                                    <th>Set Fee</th>
                                    <th>VAT</th>
                                    <th>Total Paid</th>
                                    <th>Outstanding</th>
                                    <th>Status</th>
                                    <th>Student Status</th>
                                    <th>Discount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="term1StudentsTable">
                                <tr>
                                    <td colspan="13">
                                        <div class="empty-state">
                                            <div class="icon">ðŸŽ“</div>
                                            <div class="title">No students added yet</div>
                                            <div class="subtitle">Click the + button to add your first student</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Term 2 View -->
            <div id="term2View" class="view">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="label">Total Students</div>
                        <div class="value" id="term2TotalStudents">0</div>
                        <div class="description">Enrolled in Term 2</div>
                    </div>
                    <div class="stat-card paid">
                        <div class="label">Fully Paid</div>
                        <div class="value" id="term2FullyPaid">0</div>
                        <div class="description">No outstanding balance</div>
                    </div>
                    <div class="stat-card partial">
                        <div class="label">Partially Paid</div>
                        <div class="value" id="term2PartiallyPaid">0</div>
                        <div class="description">Some payments made</div>
                    </div>
                    <div class="stat-card outstanding">
                        <div class="label">Outstanding</div>
                        <div class="value" id="term2Outstanding">Â£0</div>
                        <div class="description">Total amount due</div>
                    </div>
                </div>

                <div class="controls">
                    <input type="text" class="search-box" id="term2Search" placeholder="Search students...">
                    <select class="filter-select" id="term2Filter" onchange="applyFilter('term2')">
                        <option value="all">All Students</option>
                        <option value="paid">Fully Paid</option>
                        <option value="partial">Partially Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="active">Active Students</option>
                        <option value="left">Left Students</option>
                        <option value="outstanding">Outstanding Only</option>
                        <option value="">-- Year Groups --</option>
                        <option value="year7">Year 7</option>
                        <option value="year8">Year 8</option>
                        <option value="year9">Year 9</option>
                        <option value="year10">Year 10</option>
                        <option value="year11">Year 11</option>
                        <option value="year16+">16+</option>
                        <option value="year18+">18+</option>
                        <option value="year19+">19+</option>
                    </select>
                </div>

                <!-- Selection Controls -->
                <div class="selection-controls">
                    <button class="btn btn-secondary btn-sm" onclick="selectAllStudents('term2', 'visible')">Select All Visible</button>
                    <button class="btn btn-secondary btn-sm" onclick="deselectAllStudents('term2')">Clear Selection</button>
                    <span style="color: var(--text-secondary); font-size: 14px; margin-left: 16px;">
                        <span id="term2SelectedDisplay">0</span> selected
                    </span>
                </div>

                <!-- Bulk Actions Bar -->
                <div class="bulk-actions" id="term2BulkActions">
                    <div class="bulk-actions-text">
                        <span id="term2SelectedCount">0</span> students selected
                    </div>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-danger" onclick="bulkDeleteStudents('term2')">Delete Selected</button>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" class="select-all-checkbox" id="term2SelectAll" onchange="toggleSelectAll('term2')">
                                    </th>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>DOB</th>
                                    <th>Year</th>
                                    <th>Set Fee</th>
                                    <th>VAT</th>
                                    <th>Total Paid</th>
                                    <th>Outstanding</th>
                                    <th>Status</th>
                                    <th>Student Status</th>
                                    <th>Discount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="term2StudentsTable">
                                <tr>
                                    <td colspan="13">
                                        <div class="empty-state">
                                            <div class="icon">ðŸŽ“</div>
                                            <div class="title">No students added yet</div>
                                            <div class="subtitle">Click the + button to add your first student</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Overview View -->
            <div id="overviewView" class="view">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="label">Total Students</div>
                        <div class="value" id="overviewTotalStudents">0</div>
                        <div class="description">Across both terms</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Revenue</div>
                        <div class="value" id="overviewTotalRevenue">Â£0</div>
                        <div class="description">Collected payments</div>
                    </div>
                    <div class="stat-card outstanding">
                        <div class="label">Total Outstanding</div>
                        <div class="value" id="overviewTotalOutstanding">Â£0</div>
                        <div class="description">Across both terms</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Collection Rate</div>
                        <div class="value" id="overviewCollectionRate">0%</div>
                        <div class="description">Fees collected</div>
                    </div>
                </div>

                <!-- VAT Summary Section -->
                <div style="margin: 32px 0;">
                    <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">VAT Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div class="stat-card">
                            <div class="label">Total VAT Set</div>
                            <div class="value" id="overviewTotalVATSet">Â£0</div>
                            <div class="description">VAT on all fees</div>
                        </div>
                        <div class="stat-card paid">
                            <div class="label">VAT Collected</div>
                            <div class="value" id="overviewVATCollected">Â£0</div>
                            <div class="description">VAT received from payments</div>
                        </div>
                        <div class="stat-card outstanding">
                            <div class="label">VAT Outstanding</div>
                            <div class="value" id="overviewVATOutstanding">Â£0</div>
                            <div class="description">VAT still to collect</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="label">VAT Liability</div>
                            <div class="value" id="overviewVATLiability">Â£0</div>
                            <div class="description">Total VAT owed to HMRC</div>
                        </div>
                    </div>
                </div>

                <!-- Import CSV Section -->
                <div style="margin: 32px 0;">
                    <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">Import Student Data</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        <div class="stat-card">
                            <div class="label">CSV Import</div>
                            <div style="font-size: 20px; font-weight: 600; margin: 12px 0; color: var(--text-primary);">Upload Student Data</div>
                            <div class="description" style="margin-bottom: 16px;">Import multiple students from CSV file</div>
                            <button class="btn btn-primary" onclick="showImportModal()" style="width: 100%;">
                                ðŸ“„ Import CSV File
                            </button>
                        </div>
                        <div class="stat-card">
                            <div class="label">Quick Actions</div>
                            <div style="font-size: 20px; font-weight: 600; margin: 12px 0; color: var(--text-primary);">Choose Academic Year</div>
                            <div class="description" style="margin-bottom: 16px;">Switch between different academic years</div>
                            <button class="btn btn-secondary" onclick="showYearSelector()" style="width: 100%;">
                                ðŸ“… Select Academic Year
                            </button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 32px;">
                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border); background: var(--card-bg-elevated);">
                            <h3 style="color: var(--term1-color); font-weight: 700; font-size: 18px;">Term 1 Summary</h3>
                        </div>
                        <div id="term1Summary" style="padding: 20px;">
                            <div style="margin-bottom: 12px;">
                                <div style="color: var(--text-secondary); font-size: 14px;">Students enrolled</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--term1-color);" id="term1SummaryCount">0</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="color: var(--text-secondary); font-size: 14px;">Total fees set</div>
                                <div style="font-size: 20px; font-weight: 600;" id="term1SummaryFees">Â£0</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Outstanding</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--danger);" id="term1SummaryOutstanding">Â£0</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border); background: var(--card-bg-elevated);">
                            <h3 style="color: var(--term2-color); font-weight: 700; font-size: 18px;">Term 2 Summary</h3>
                        </div>
                        <div id="term2Summary" style="padding: 20px;">
                            <div style="margin-bottom: 12px;">
                                <div style="color: var(--text-secondary); font-size: 14px;">Students enrolled</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--term2-color);" id="term2SummaryCount">0</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="color: var(--text-secondary); font-size: 14px;">Total fees set</div>
                                <div style="font-size: 20px; font-weight: 600;" id="term2SummaryFees">Â£0</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Outstanding</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--danger);" id="term2SummaryOutstanding">Â£0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="view">
                <div class="controls">
                    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px; color: var(--text-primary);">PDF Reports</h2>
                </div>

                <div class="pdf-export-section">
                    <div class="pdf-export-card">
                        <h3>ðŸ“Š Term 1 Detailed Report</h3>
                        <p>Comprehensive report with all Term 1 student data, payment details, and analytics</p>
                        <button class="pdf-btn" onclick="exportPDFReport('term1', 'detailed')" id="term1DetailedBtn">
                            <div class="pdf-loading" id="term1DetailedSpinner"></div>
                            ðŸ“„ Generate Term 1 PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸ“Š Term 2 Detailed Report</h3>
                        <p>Comprehensive report with all Term 2 student data, payment details, and analytics</p>
                        <button class="pdf-btn" onclick="exportPDFReport('term2', 'detailed')" id="term2DetailedBtn">
                            <div class="pdf-loading" id="term2DetailedSpinner"></div>
                            ðŸ“„ Generate Term 2 PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸ’° Outstanding Fees Report</h3>
                        <p>Report focusing on students with outstanding balances</p>
                        <button class="pdf-btn" onclick="showOutstandingReportOptions()" id="outstandingBtn">
                            <div class="pdf-loading" id="outstandingSpinner"></div>
                            ðŸ“„ Generate Outstanding PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸ’³ VAT Summary Report</h3>
                        <p>Complete VAT breakdown for HMRC compliance and accounting purposes</p>
                        <button class="pdf-btn" onclick="exportPDFReport('all', 'vat')" id="vatBtn">
                            <div class="pdf-loading" id="vatSpinner"></div>
                            ðŸ“„ Generate VAT PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸ“ˆ Financial Summary</h3>
                        <p>Executive summary with key financial metrics and collection statistics</p>
                        <button class="pdf-btn" onclick="exportPDFReport('all', 'summary')" id="summaryBtn">
                            <div class="pdf-loading" id="summarySpinner"></div>
                            ðŸ“„ Generate Summary PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸ’³ Payment Methods Analysis</h3>
                        <p>Detailed breakdown of payment methods and collection patterns</p>
                        <button class="pdf-btn" onclick="exportPDFReport('all', 'payments')" id="paymentsBtn">
                            <div class="pdf-loading" id="paymentsSpinner"></div>
                            ðŸ“„ Generate Payments PDF
                        </button>
                    </div>

                    <div class="pdf-export-card">
                        <h3>ðŸŽ“ Year Group Analysis</h3>
                        <p>Student distribution and financial metrics by year group</p>
                        <button class="pdf-btn" onclick="exportPDFReport('all', 'yeargroups')" id="yearGroupsBtn">
                            <div class="pdf-loading" id="yearGroupsSpinner"></div>
                            ðŸ“„ Generate Year Groups PDF
                        </button>
                    </div>
                </div>

                <div class="table-container" style="margin-top: 32px;">
                    <div style="padding: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">Add Report Notes</h3>
                        <textarea id="reportNotes" class="form-textarea" placeholder="Add notes that will be included in PDF reports..."></textarea>
                    </div>
                </div>
                <div style="margin-top: 32px;">
                    <div class="pdf-export-card">
                        <h3>ðŸ’¾ Complete Data Backup</h3>
                        <p>Download ALL student data in one file that can restore everything perfectly</p>
                        <div style="display: flex; gap: 8px; flex-direction: column;">
                            <button class="pdf-btn" onclick="exportToCSV('complete')" style="margin-bottom: 8px;">
                                ðŸ’¾ Download Complete Backup
                            </button>
                            <button class="pdf-btn" onclick="showImportCSV()" style="background: var(--info);">
                                ðŸ“‚ Restore Complete Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="view">
                <div class="controls">
                    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px; color: var(--text-primary);">Analytics Dashboard</h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Collection Trend</div>
                        <div class="value" id="collectionTrend">+15%</div>
                        <div class="description">vs previous period</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Avg Payment Time</div>
                        <div class="value" id="avgPaymentTime">23 days</div>
                        <div class="description">from enrollment</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Payment Methods</div>
                        <div class="value" id="topPaymentMethod">Bank</div>
                        <div class="description">most popular</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Discount Usage</div>
                        <div class="value" id="discountUsage">12%</div>
                        <div class="description">of students</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 32px;">
                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                            <h3 style="font-weight: 700; font-size: 18px;">Payment Timeline</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="paymentChart"></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                            <h3 style="font-weight: 700; font-size: 18px;">Year Group Analysis</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="yearGroupStats"></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                            <h3 style="font-weight: 700; font-size: 18px;">Payment Methods Breakdown</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="paymentMethodsChart"></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                            <h3 style="font-weight: 700; font-size: 18px;">Outstanding by Year</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="outstandingByYear"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="fab-container">
        <button class="fab" onclick="showAddStudent()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    // Replace the existing Outstanding Report Options Modal HTML (around line 1477)
    <!-- Outstanding Report Options Modal -->
    <div id="outstandingOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Outstanding Fees Report</h2>
                <button class="close-btn" onclick="closeModal('outstandingOptionsModal')">&times;</button>
            </div>
            
            <div class="section">
                <div class="section-title">Select Report Format</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <label class="format-option" style="display: flex; align-items: center; padding: 16px; background: var(--card-bg-elevated); border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="reportFormat" value="pdf" checked style="margin-right: 12px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">ðŸ“„ PDF Format</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Best for printing and sharing</div>
                        </div>
                    </label>
                    <label class="format-option" style="display: flex; align-items: center; padding: 16px; background: var(--card-bg-elevated); border-radius: 12px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="reportFormat" value="excel" style="margin-right: 12px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">ðŸ“Š Excel Format</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Best for analysis and editing</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Select Report Scope</div>
                <div style="display: grid; gap: 12px;">
                    <button class="btn btn-primary" onclick="handleOutstandingReportFormat('term1');">
                        ðŸ“Š Term 1 Outstanding Only
                    </button>
                    <button class="btn btn-primary" onclick="handleOutstandingReportFormat('term2');">
                        ðŸ“Š Term 2 Outstanding Only
                    </button>
                    <button class="btn btn-primary" onclick="handleOutstandingReportFormat('all');">
                        ðŸ“Š Complete Year Outstanding
                    </button>
                </div>
            </div>
    
            <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button type="button" class="btn btn-secondary" onclick="closeModal('outstandingOptionsModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Academic Year Selector Modal -->
    <div id="yearSelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Choose Academic Year</h2>
                <button class="close-btn" onclick="closeModal('yearSelectorModal')">&times;</button>
            </div>
            
            <div class="section">
                <div class="section-title">Available Academic Years</div>
                <div class="form-group">
                    <label class="form-label">Select Academic Year</label>
                    <select class="form-select" id="academicYearSelect">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div style="margin-top: 16px; padding: 16px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Current Academic Year:</div>
                    <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="currentYearDisplay">2025-2026</div>
                </div>
                
                <div style="margin-top: 16px; padding: 16px; background: rgba(255, 149, 0, 0.1); border-radius: 12px; border: 1px solid rgba(255, 149, 0, 0.3);">
                    <div style="font-size: 12px; color: var(--warning); font-weight: 600; margin-bottom: 4px;">âš ï¸ Important</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Switching academic years will save current data and load data for the selected year. Each year maintains separate student records.</div>
                </div>
            </div>

            <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button type="button" class="btn btn-secondary" onclick="closeModal('yearSelectorModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmYearChange()">Switch Year</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Student</h2>
                <button class="close-btn" onclick="closeModal('studentModal')">&times;</button>
            </div>
            <form id="studentForm" onsubmit="saveStudent(event)">
                <!-- Basic Info Section -->
                <div class="section">
                    <div class="section-title">Student Information</div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="studentFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="studentLastName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth (DD/MM/YYYY)</label>
                            <div style="position: relative;">
                                <input type="text" 
                                       class="form-input date-input" 
                                       id="studentDOB" 
                                       placeholder="DD/MM/YYYY" 
                                       pattern="\d{2}/\d{2}/\d{4}"
                                       maxlength="10"
                                       required
                                       oninput="autoFormatDate(this)"
                                       style="padding-right: 40px;">
                                <button type="button" 
                                        class="date-picker-btn" 
                                        onclick="showDatePicker('studentDOB')"
                                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; cursor: pointer; font-size: 16px; 
                                               color: var(--text-secondary); padding: 4px;">
                                    ðŸ“…
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fees Section -->
                <div class="section">
                    <div class="section-title">Fees & Year</div>
                    <div class="form-grid-4">
                        <div class="form-group">
                            <label class="form-label">Year Group</label>
                            <select class="form-select" id="studentYear" required>
                                <option value="">Select Year</option>
                                <option value="7">Year 7</option>
                                <option value="8">Year 8</option>
                                <option value="9">Year 9</option>
                                <option value="10">Year 10</option>
                                <option value="11">Year 11</option>
                                <option value="16+">16+</option>
                                <option value="18+">18+</option>
                                <option value="19+">19+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Set Fee (Â£)</label>
                            <input type="number" step="0.01" class="form-input" id="studentFee" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">VAT (Â£)</label>
                            <input type="number" step="0.01" class="form-input" id="studentVAT" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Student Status</label>
                            <div class="status-options">
                                <div class="status-option">
                                    <input type="radio" id="statusActive" name="studentStatus" value="active" checked>
                                    <label for="statusActive">Active</label>
                                </div>
                                <div class="status-option">
                                    <input type="radio" id="statusLeft" name="studentStatus" value="left">
                                    <label for="statusLeft">Left</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discount Section -->
                <div class="section">
                    <div class="section-title">Sibling Discount</div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Discount Type</label>
                            <select class="form-select" id="discountType">
                                <option value="none">No Discount</option>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discount Value</label>
                            <input type="number" step="0.01" class="form-input" id="discountValue" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sibling Names</label>
                            <input type="text" class="form-input" id="siblingNames" placeholder="Names of siblings">
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div class="section">
                    <div class="section-title">Payments</div>
                    <div id="paymentsContainer">
                        <div class="payment-row">
                            <div class="form-group">
                                <label class="form-label">Amount (Â£)</label>
                                <input type="number" step="0.01" class="form-input" name="paymentAmount[]">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Invoice No.</label>
                                <input type="text" class="form-input" name="paymentInvoice[]">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date (DD/MM/YYYY)</label>
                                <div style="position: relative;">
                                    <input type="text" 
                                           class="form-input date-input" 
                                           name="paymentDate[]" 
                                           placeholder="DD/MM/YYYY" 
                                           pattern="\d{2}/\d{2}/\d{4}"
                                           maxlength="10"
                                           oninput="autoFormatDate(this)"
                                           style="padding-right: 40px;">
                                    <button type="button" 
                                            class="date-picker-btn" 
                                            onclick="showDatePicker(this.previousElementSibling.id || 'paymentDate_' + Date.now())"
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                                   background: none; border: none; cursor: pointer; font-size: 16px; 
                                                   color: var(--text-secondary); padding: 4px;">
                                        ðŸ“…
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Method</label>
                                <select class="form-select" name="paymentMethod[]">
                                    <option value="">Select Method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Card">Card</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" class="delete-payment" onclick="removePaymentEntry(this)" style="visibility: hidden;">&times;</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-payment-btn" onclick="addPaymentEntry()">
                        + Add Payment
                    </button>
                </div>

                <!-- Comments Section -->
                <div class="section">
                    <div class="section-title">Comments</div>
                    <div class="form-group">
                        <textarea class="form-textarea" id="studentComments" placeholder="Any additional notes..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('studentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student View Modal -->
    <div id="studentViewModal" class="modal">
        <div class="modal-content view-modal-content">
            <div class="modal-header">
                <h2 id="viewModalTitle">Student Overview</h2>
                <button class="close-btn" onclick="closeModal('studentViewModal')">&times;</button>
            </div>
            
            <div class="student-overview">
                <div class="student-info-card">
                    <div class="student-name" id="viewStudentName">Loading...</div>
                    
                    <div class="student-details">
                        <div class="detail-item">
                            <div class="detail-label">Date of Birth</div>
                            <div class="detail-value" id="viewStudentDOB">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Group</div>
                            <div class="detail-value" id="viewStudentYear">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Term</div>
                            <div class="detail-value" id="viewStudentTerm">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Student Status</div>
                            <div class="detail-value" id="viewStudentStatus">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Enrolled</div>
                            <div class="detail-value" id="viewStudentCreated">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value" id="viewStudentUpdated">-</div>
                        </div>
                    </div>

                    <div style="margin-top: 24px;" id="viewStudentComments">
                        <div class="detail-label">Comments</div>
                        <div class="detail-value" style="margin-top: 8px; line-height: 1.5;" id="viewStudentCommentsText">No comments available</div>
                    </div>

                    <div style="margin-top: 24px;" id="viewStudentDiscount">
                        <div class="detail-label">Sibling Discount</div>
                        <div class="detail-value" style="margin-top: 8px;" id="viewStudentDiscountText">None</div>
                    </div>
                </div>

                <div class="student-summary-card">
                    <div class="summary-amount" id="viewOutstandingAmount">Â£0.00</div>
                    <div class="summary-label">Outstanding Balance</div>
                    
                    <div class="summary-breakdown">
                        <div class="breakdown-item">
                            <span>Set Fee</span>
                            <span id="viewSetFee">Â£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>VAT</span>
                            <span id="viewVAT">Â£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Total Fee</span>
                            <span id="viewTotalFee">Â£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Discount</span>
                            <span id="viewDiscountAmount">Â£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>After Discount</span>
                            <span id="viewAfterDiscount">Â£0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Total Paid</span>
                            <span id="viewTotalPaid">Â£0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="payments-history">
                <div class="payments-header">
                    <h3 style="font-size: 18px; font-weight: 700; margin: 0;">Payment History</h3>
                    <span id="viewPaymentCount" style="color: var(--text-secondary); font-size: 14px;">0 payments</span>
                </div>
                
                <div id="viewPaymentsTableContainer">
                    <table class="payments-table" id="viewPaymentsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Invoice No.</th>
                                <th>Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="viewPaymentsBody">
                        </tbody>
                    </table>
                    
                    <div id="viewNoPayments" class="no-payments">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.4;">ðŸ’³</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Payments Recorded</div>
                        <div style="font-size: 14px;">This student hasn't made any payments yet</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button type="button" class="btn btn-secondary" onclick="closeModal('studentViewModal')">Close</button>
                <button type="button" class="btn btn-info" onclick="editStudentFromView()" id="editFromViewBtn">Edit Student</button>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addPaymentModalTitle">Add Payment</h2>
                <button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button>
            </div>
            
            <div class="section">
                <div class="section-title">Student Information</div>
                <div id="paymentStudentInfo" style="padding: 16px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;" id="paymentStudentName">Student Name</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 14px; color: var(--text-secondary);">
                        <div>Term: <span id="paymentStudentTerm">-</span></div>
                        <div>Year: <span id="paymentStudentYear">-</span></div>
                        <div>Outstanding: <span id="paymentStudentOutstanding" style="color: var(--danger); font-weight: 600;">Â£0.00</span></div>
                    </div>
                </div>
            </div>

            <form id="addPaymentForm" onsubmit="savePayment(event)">
                <div class="section">
                    <div class="section-title">Payment Details</div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Payment Amount (Â£)</label>
                            <input type="number" step="0.01" class="form-input" id="paymentAmount" required min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Date (DD/MM/YYYY)</label>
                            <div style="position: relative;">
                                <input type="text" 
                                       class="form-input date-input" 
                                       id="paymentDate" 
                                       placeholder="DD/MM/YYYY" 
                                       pattern="\d{2}/\d{2}/\d{4}"
                                       maxlength="10"
                                       required
                                       oninput="autoFormatDate(this)"
                                       style="padding-right: 40px;">
                                <button type="button" 
                                        class="date-picker-btn" 
                                        onclick="showDatePicker('paymentDate')"
                                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; cursor: pointer; font-size: 16px; 
                                               color: var(--text-secondary); padding: 4px;">
                                    ðŸ“…
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice Number</label>
                            <input type="text" class="form-input" id="paymentInvoice" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Card">Card</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPaymentModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Student Data</h2>
                <button class="close-btn" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div>
                <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;">
                    Upload a CSV file with student data. Required columns: Student Name, DOB (DD/MM/YYYY), School Year, Set Fee, VAT Amount
                </p>
                
                <div class="file-upload-area" onclick="document.getElementById('csvFileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">ðŸ“„</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Click to upload CSV file</div>
                    <div style="color: var(--text-secondary);">Or drag and drop your file here</div>
                </div>
                
                <input type="file" id="csvFileInput" class="file-upload-input" accept=".csv" onchange="handleCSVUpload(event)">
                
                <div style="margin-top: 24px;">
                    <label class="form-label">Import to Term</label>
                    <select class="form-select" id="importTerm">
                        <option value="term1">Term 1</option>
                        <option value="term2">Term 2</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processCSVImport()" id="importBtn" disabled>Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Utility function for formatting numbers with commas
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0';
        return parseFloat(num).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Utility function for formatting currency with commas
    function formatCurrency(num) {
        if (num === null || num === undefined || isNaN(num)) return 'Â£0.00';
        return 'Â£' + parseFloat(num).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Enhanced date formatting utility functions
    function formatDateToUK(dateInput) {
        if (!dateInput) return '';
        
        // If it's already in DD/MM/YYYY format, return as is
        if (typeof dateInput === 'string' && dateInput.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dateInput;
        }
        
        let date;
        if (typeof dateInput === 'string') {
            // Handle various input formats
            if (dateInput.includes('-')) {
                // ISO format (YYYY-MM-DD) or similar
                date = new Date(dateInput);
            } else if (dateInput.includes('/')) {
                // Try to parse as DD/MM/YYYY first
                const parts = dateInput.split('/');
                if (parts.length === 3) {
                    // Assume DD/MM/YYYY
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    date = new Date(dateInput);
                }
            } else {
                date = new Date(dateInput);
            }
        } else {
            date = new Date(dateInput);
        }
        
        if (isNaN(date.getTime())) {
            return dateInput; // Return original if parsing fails
        }
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
    }

    function parseUKDateToISO(ukDate) {
        if (!ukDate) return '';
        
        // If it's already in ISO format, return as is
        if (ukDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return ukDate;
        }
        
        // Parse DD/MM/YYYY format
        const parts = ukDate.split('/');
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        
        return ukDate;
    }

    function setTodayInUKFormat(inputId) {
        const today = new Date();
        const ukDate = formatDateToUK(today);
        const input = document.getElementById(inputId);
        if (input) {
            input.value = ukDate;
        }
        return ukDate;
    }

    // Auto-format date input as user types
    function autoFormatDate(input) {
        let value = input.value.replace(/\D/g, ''); // Remove non-digits
        
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        if (value.length >= 5) {
            value = value.substring(0, 5) + '/' + value.substring(5);
        }
        if (value.length > 10) {
            value = value.substring(0, 10);
        }
        
        input.value = value;
        
        // Validate complete date
        if (value.length === 10) {
            const parts = value.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                
                if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
                    input.setCustomValidity('Please enter a valid date in DD/MM/YYYY format');
                } else {
                    input.setCustomValidity('');
                }
            }
        } else {
            input.setCustomValidity('');
        }
    }

    // Enhanced date input with both picker and manual entry
    function createDateInput(id, placeholder = 'DD/MM/YYYY', required = false) {
        return `
            <div style="position: relative;">
                <input type="text" 
                       class="form-input date-input" 
                       id="${id}" 
                       placeholder="${placeholder}" 
                       pattern="\\d{2}/\\d{2}/\\d{4}"
                       maxlength="10"
                       ${required ? 'required' : ''}
                       oninput="autoFormatDate(this)"
                       style="padding-right: 40px;">
                <button type="button" 
                        class="date-picker-btn" 
                        onclick="showDatePicker('${id}')"
                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                               background: none; border: none; cursor: pointer; font-size: 16px; 
                               color: var(--text-secondary); padding: 4px;">
                    ðŸ“…
                </button>
            </div>
        `;
    }

    function showDatePicker(inputId) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        // Create a hidden date input
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.style.position = 'absolute';
        dateInput.style.opacity = '0';
        dateInput.style.pointerEvents = 'none';
        
        // Convert existing DD/MM/YYYY to YYYY-MM-DD
        if (input.value && input.value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            const parts = input.value.split('/');
            dateInput.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        // When date is selected, convert back to DD/MM/YYYY
        dateInput.onchange = function() {
            if (this.value) {
                const parts = this.value.split('-');
                input.value = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            document.body.removeChild(this);
        };
        
        // Add to page and trigger click
        document.body.appendChild(dateInput);
        dateInput.click();
    }

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC-AM7-3HdvjRpJMDVQLfxUsZmgh1aA8UU",
        authDomain: "dul-accounts-21118.firebaseapp.com",
        projectId: "dul-accounts-21118",
        storageBucket: "dul-accounts-21118.firebasestorage.app",
        messagingSenderId: "484339552499",
        appId: "1:484339552499:web:1dff66886e1627a178a786"
    };

    // Year group sorting function
    function getYearGroupOrder(year) {
        const yearOrder = {
            '7': 1,
            '8': 2,
            '9': 3,
            '10': 4,
            '11': 5,
            '16+': 6,
            '18+': 7,
            '19+': 8
        };
        return yearOrder[year] || 999; // Unknown years go to end
    }

    function sortStudentsByYear(students) {
        return students.sort((a, b) => {
            const aOrder = getYearGroupOrder(a.year);
            const bOrder = getYearGroupOrder(b.year);
            
            if (aOrder !== bOrder) {
                return aOrder - bOrder; // Primary sort by year
            }
            
            // Secondary sort by last name if same year
            const aLastName = (a.lastName || '').toLowerCase();
            const bLastName = (b.lastName || '').toLowerCase();
            return aLastName.localeCompare(bLastName);
        });
    }

    // Show Outstanding Report Options
    function showOutstandingReportOptions() {
        const modal = document.getElementById('outstandingOptionsModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    // Academic Year Management
    let currentAcademicYear = '2025-2026';

    function initializeAcademicYear() {
        const savedYear = localStorage.getItem('currentAcademicYear');
        if (savedYear) {
            currentAcademicYear = savedYear;
        }
        updateAcademicYearUI();
        loadDataForYear(currentAcademicYear);
    }

    function updateAcademicYearUI() {
        // Update year badge in header
        const yearBadge = document.querySelector('.year-badge');
        if (yearBadge) {
            yearBadge.textContent = currentAcademicYear;
        }
        
        // Update current year display in modal
        const yearDisplay = document.getElementById('currentYearDisplay');
        if (yearDisplay) {
            yearDisplay.textContent = currentAcademicYear;
        }
        
        // Update all headers and titles that show academic year
        const headers = document.querySelectorAll('.academic-year-text');
        headers.forEach(header => {
            header.textContent = `Academic Year: ${currentAcademicYear}`;
        });
    }

    function showYearSelector() {
        const modal = document.getElementById('yearSelectorModal');
        if (modal) {
            // Populate year options (5 years from 2025 onwards)
            const yearSelect = document.getElementById('academicYearSelect');
            if (yearSelect) {
                yearSelect.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const startYear = 2025 + i;
                    const endYear = startYear + 1;
                    const yearOption = `${startYear}-${endYear}`;
                    const option = document.createElement('option');
                    option.value = yearOption;
                    option.textContent = yearOption;
                    if (yearOption === currentAcademicYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
            }
            modal.classList.add('active');
        }
    }

    function confirmYearChange() {
        const yearSelect = document.getElementById('academicYearSelect');
        const newYear = yearSelect ? yearSelect.value : null;
        
        if (newYear && newYear !== currentAcademicYear) {
            changeAcademicYear(newYear);
        } else {
            closeModal('yearSelectorModal');
        }
    }

    // Updated year change function
    function changeAcademicYear(newYear) {
        if (newYear === currentAcademicYear) return;
        
        if (confirm(`Switch to academic year ${newYear}?`)) {
            // Clean up old listeners FIRST
            cleanupListeners();
            
            // Save current year data
            saveLocalData();
            
            // Switch to new year
            currentAcademicYear = newYear;
            localStorage.setItem('currentAcademicYear', newYear);
            
            // Load new year data
            loadDataForYear(newYear);
            updateAcademicYearUI();
            updateAllUI();
            
            // Set up new listeners with proper delay and checks
            setTimeout(() => {
                if (currentUser && isOnline && !isListenerSetup) {
                    setupRealtimeSync();
                }
            }, 2000); // Longer delay
            
            closeModal('yearSelectorModal');
            
            setTimeout(() => {
                alert(`Successfully switched to academic year ${newYear}`);
            }, 500);
        }
    }

    function loadDataForYear(year) {
        // Reset current data
        window.term1Students = [];
        window.term2Students = [];
        
        // Reset selections
        selectedStudents.term1.clear();
        selectedStudents.term2.clear();
        
        // Load from localStorage for the specific year
        const term1Key = `dulTerm1Students_${year}`;
        const term2Key = `dulTerm2Students_${year}`;
        
        const term1Data = localStorage.getItem(term1Key);
        const term2Data = localStorage.getItem(term2Key);
        
        if (term1Data) {
            try {
                window.term1Students = JSON.parse(term1Data);
                console.log('Term 1 data loaded for year', year, ':', window.term1Students.length, 'students');
            } catch (e) {
                console.error('Error loading term 1 data for year', year, ':', e);
                window.term1Students = [];
            }
        }
        
        if (term2Data) {
            try {
                window.term2Students = JSON.parse(term2Data);
                console.log('Term 2 data loaded for year', year, ':', window.term2Students.length, 'students');
            } catch (e) {
                console.error('Error loading term 2 data for year', year, ':', e);
                window.term2Students = [];
            }
        }
        
        // Load from Firebase for the specific year if online
        if (currentUser && isOnline) {
            loadFromFirebase(year);
        }
        
        // Update UI after loading
        updateAllUI();
    }

    function loadFromFirebase(year) {
        if (!currentUser || !isOnline) return;
        
        const db = firebase.firestore();
        const yearKey = year.replace('-', '_'); // Convert 2025-2026 to 2025_2026
        
        // Load Term 1 data for specific year
        db.collection('studentFees').doc(`term1_${yearKey}`).get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.students) {
                        window.term1Students = data.students;
                        saveLocalDataForYear(year);
                        updateAllUI();
                        console.log('Term 1 data loaded from Firebase for year', year);
                    }
                }
            })
            .catch((error) => {
                console.error('Error loading Term 1 from Firebase for year', year, ':', error);
            });
        
        // Load Term 2 data for specific year
        db.collection('studentFees').doc(`term2_${yearKey}`).get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.students) {
                        window.term2Students = data.students;
                        saveLocalDataForYear(year);
                        updateAllUI();
                        console.log('Term 2 data loaded from Firebase for year', year);
                    }
                }
            })
            .catch((error) => {
                console.error('Error loading Term 2 from Firebase for year', year, ':', error);
            });
    }

    function saveLocalDataForYear(year) {
        try {
            const term1Key = `dulTerm1Students_${year}`;
            const term2Key = `dulTerm2Students_${year}`;
            
            localStorage.setItem(term1Key, JSON.stringify(window.term1Students));
            localStorage.setItem(term2Key, JSON.stringify(window.term2Students));
            localStorage.setItem('dulStudentsTimestamp', Date.now().toString());
            console.log('Local data saved for year', year);
        } catch (e) {
            console.error('Failed to save local data for year', year, ':', e);
        }
    }

    // Global variables
    let currentUser = null;
    let currentTerm = 'term1';
    let currentStudentId = null;
    let currentViewStudentId = null;
    let currentViewTerm = null;
    let currentPaymentStudentId = null;
    let currentPaymentTerm = null;
    let isOnline = navigator.onLine;
    let isSyncing = false;
    let unsubscribeTerm1 = null;
    let unsubscribeTerm2 = null;
    let csvData = null;
    let families = [];
    let archivedYears = [];

    let selectedStudents = {
        term1: new Set(),
        term2: new Set()
    };

    // Data storage
    window.term1Students = [];
    window.term2Students = [];

    // Bulk selection functions
    function toggleStudentSelection(studentId, term) {
        console.log(`Toggling selection for student ${studentId} in ${term}`);
        const checkbox = document.querySelector(`#${term}StudentsTable input[data-student-id="${studentId}"]`);
        if (checkbox && checkbox.checked) {
            selectedStudents[term].add(studentId);
            console.log(`Added student ${studentId} to selection`);
        } else {
            selectedStudents[term].delete(studentId);
            console.log(`Removed student ${studentId} from selection`);
        }
        updateBulkActionsUI(term);
        updateSelectAllCheckbox(term);
        console.log(`Total selected in ${term}: ${selectedStudents[term].size}`);
    }

    function toggleSelectAll(term) {
        const selectAllCheckbox = document.getElementById(`${term}SelectAll`);
        const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : false;
        
        console.log(`ToggleSelectAll ${term}: ${isChecked ? 'checking' : 'unchecking'} all visible`);
        
        const tableBody = document.querySelector(`#${term}StudentsTable tbody`);
        if (!tableBody) {
            console.error(`Table body not found for ${term}`);
            return;
        }
        
        const visibleRows = Array.from(tableBody.querySelectorAll('tr')).filter(row => {
            return row.style.display !== 'none' && !row.querySelector('.empty-state');
        });
        
        console.log(`Found ${visibleRows.length} visible rows to ${isChecked ? 'select' : 'deselect'}`);
        
        visibleRows.forEach(row => {
            const checkbox = row.querySelector('input.student-checkbox');
            if (checkbox) {
                checkbox.checked = isChecked;
                const studentId = checkbox.getAttribute('data-student-id');
                if (studentId) {
                    if (isChecked) {
                        selectedStudents[term].add(studentId);
                    } else {
                        selectedStudents[term].delete(studentId);
                    }
                }
            }
        });
        
        updateBulkActionsUI(term);
        console.log(`ToggleSelectAll complete. Total selected in ${term}: ${selectedStudents[term].size}`);
    }

    function selectAllStudents(term, scope) {
        console.log(`Attempting to select ${scope} students in ${term}`);
        
        if (scope === 'visible') {
            // Get all visible student checkboxes directly
            const checkboxes = document.querySelectorAll(`#${term}StudentsTable input.student-checkbox`);
            
            if (checkboxes.length === 0) {
                console.log(`No student checkboxes found in ${term}`);
                return;
            }
            
            let selectedCount = 0;
            
            // Check each checkbox and add to selection
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                
                // Only select if the row is visible (not filtered out)
                if (row && row.style.display !== 'none') {
                    checkbox.checked = true;
                    const studentId = checkbox.getAttribute('data-student-id');
                    if (studentId) {
                        selectedStudents[term].add(studentId);
                        selectedCount++;
                    }
                }
            });
            
            console.log(`Selected ${selectedCount} visible students in ${term}`);
            
        } else if (scope === 'all') {
            // Select all students regardless of visibility
            const students = term === 'term1' ? window.term1Students : window.term2Students;
            selectedStudents[term].clear();
            
            students.forEach(student => selectedStudents[term].add(student.id));
            
            // Check all checkboxes
            document.querySelectorAll(`#${term}StudentsTable input.student-checkbox`).forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        // Update UI
        updateSelectAllCheckbox(term);
        updateBulkActionsUI(term);
        
        console.log(`Total selected in ${term}: ${selectedStudents[term].size}`);
    }

    function deselectAllStudents(term) {
        console.log(`Deselecting all students in ${term}`);
        selectedStudents[term].clear();
        
        // Uncheck all checkboxes
        document.querySelectorAll(`#${term}StudentsTable input.student-checkbox`).forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateSelectAllCheckbox(term);
        updateBulkActionsUI(term);
        console.log(`Cleared selections in ${term}: ${selectedStudents[term].size} students selected`);
    }

    function updateSelectAllCheckbox(term) {
        const selectAllCheckbox = document.getElementById(`${term}SelectAll`);
        if (!selectAllCheckbox) return;
        
        const tableBody = document.querySelector(`#${term}StudentsTable tbody`);
        if (!tableBody) return;
        
        const visibleRows = Array.from(tableBody.querySelectorAll('tr')).filter(row => {
            return row.style.display !== 'none' && !row.querySelector('.empty-state');
        });
        
        const visibleCheckboxes = visibleRows.map(row => row.querySelector('input.student-checkbox')).filter(cb => cb);
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
        
        console.log(`UpdateSelectAll ${term}: ${checkedVisible.length}/${visibleCheckboxes.length} visible checkboxes checked`);
        
        if (visibleCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedVisible.length === visibleCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedVisible.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    function updateBulkActionsUI(term) {
        const bulkActions = document.getElementById(`${term}BulkActions`);
        const selectedCount = document.getElementById(`${term}SelectedCount`);
        const selectedDisplay = document.getElementById(`${term}SelectedDisplay`);
        
        const count = selectedStudents[term].size;
        
        if (count > 0) {
            bulkActions.classList.add('show');
            if (selectedCount) selectedCount.textContent = count;
        } else {
            bulkActions.classList.remove('show');
        }
        
        // Update the selection counter in controls
        if (selectedDisplay) {
            selectedDisplay.textContent = count;
        }
    }

    function bulkDeleteStudents(term) {
        const count = selectedStudents[term].size;
        
        if (count === 0) {
            alert('No students selected for deletion.');
            return;
        }
        
        if (!confirm(`Are you sure you want to permanently delete ${count} selected student${count > 1 ? 's' : ''}? This action cannot be undone.`)) {
            return;
        }
        
        // Get the students array
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        
        // Filter out selected students
        const remainingStudents = students.filter(student => !selectedStudents[term].has(student.id));
        
        // Update the array
        if (term === 'term1') {
            window.term1Students = remainingStudents;
        } else {
            window.term2Students = remainingStudents;
        }
        
        // Clear selections
        selectedStudents[term].clear();
        
        // Save and update UI
        saveLocalData();
        saveToFirebase(currentAcademicYear, term);
        updateAllUI();
        
        alert(`Successfully deleted ${count} student${count > 1 ? 's' : ''}.`);
    }

    // Core calculation functions
    function getTotalPaid(student) {
        const payments = student.payments || [];
        return payments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
    }

    function calculateDiscount(student) {
        if (!student.discount || student.discount.type === 'none') return 0;
        
        const totalFee = (parseFloat(student.setFee) || 0) + (parseFloat(student.vat) || 0);
        const discountValue = parseFloat(student.discount.value) || 0;
        
        if (student.discount.type === 'percentage') {
            return (totalFee * discountValue) / 100;
        } else if (student.discount.type === 'fixed') {
            return Math.min(discountValue, totalFee);
        }
        
        return 0;
    }

    function getOutstandingAmount(student, term) {
        const totalFee = (parseFloat(student.setFee) || 0) + (parseFloat(student.vat) || 0);
        const discount = calculateDiscount(student);
        const discountedFee = totalFee - discount;
        const totalPaid = getTotalPaid(student);
        return Math.max(0, discountedFee - totalPaid);
    }

    function getPaymentStatus(student, term) {
        const outstanding = getOutstandingAmount(student, term);
        const totalPaid = getTotalPaid(student);
        
        if (outstanding === 0) return 'paid';
        if (totalPaid > 0) return 'partial';
        return 'unpaid';
    }

    function getDiscountText(student) {
        if (!student.discount || student.discount.type === 'none') return 'None';
        
        const discount = calculateDiscount(student);
        if (student.discount.type === 'percentage') {
            return `${student.discount.value}% (${formatCurrency(discount)})`;
        } else if (student.discount.type === 'fixed') {
            return formatCurrency(discount);
        }
        
        return 'None';
    }

    // Initialize app - FIXED to show UI immediately
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Student Fees App starting...');
        
        try {
            // IMMEDIATELY show the main interface
            const loadingEl = document.getElementById('appLoading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
                console.log('Loading hidden immediately');
            }
            
            // Initialize academic year management
            initializeAcademicYear();
            
            // Initialize with empty/local data first
            loadLocalData();
            updateAllUI();
            setupSearchFilters();
            setupFileUpload();
            
            console.log('UI initialized with local data');
            
            // Initialize Firebase in background (non-blocking)
            setTimeout(function() {
                initFirebase().catch(function(error) {
                    console.error('Firebase initialization failed:', error);
                    updateSyncStatus('offline');
                });
            }, 100);
            
            setupNetworkMonitoring();
            
        } catch (error) {
            console.error('App initialization error:', error);
            // Always ensure loading is hidden
            const loadingEl = document.getElementById('appLoading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }
    });

    function initFirebase() {
        return new Promise(function(resolve, reject) {
            try {
                console.log('Initializing Firebase...');
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase not loaded');
                }
                
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                
                // Handle offline/connection issues more gracefully
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                });
                
                // Set up persistence with better error handling
                Promise.all([
                    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
                        console.warn('Persistence error (continuing anyway):', err.code);
                        return Promise.resolve();
                    }),
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(err => {
                        console.warn('Auth persistence error (continuing anyway):', err.code);
                        return Promise.resolve();
                    })
                ]).then(function() {
                    // Set up auth state listener
                    auth.onAuthStateChanged(function(user) {
                        handleAuthStateChange(user).catch(function(error) {
                            console.error('Auth state change error:', error);
                            updateSyncStatus('offline');
                        });
                    });
                    
                    // Try to sign in
                    if (!auth.currentUser) {
                        signInUser().catch(function(error) {
                            console.error('Sign in failed (continuing offline):', error);
                            updateSyncStatus('offline');
                        });
                    }
                    
                    resolve(true);
                }).catch(function(error) {
                    console.error('Firebase setup error (continuing offline):', error);
                    updateSyncStatus('offline');
                    resolve(true); // Continue even if Firebase fails
                });
                
            } catch (error) {
                console.error('Firebase init error (continuing offline):', error);
                handleOfflineMode();
                resolve(true); // Don't reject, just continue offline
            }
        });
    }

    function signInUser() {
        return new Promise(function(resolve, reject) {
            try {
                console.log('Attempting sign in...');
                const auth = firebase.auth();
                auth.signInAnonymously().then(function(credential) {
                    currentUser = credential.user;
                    console.log('Signed in successfully:', currentUser.uid);
                    resolve(true);
                }).catch(function(error) {
                    console.error('Sign in error:', error);
                    if (isOnline) {
                        setTimeout(function() {
                            signInUser();
                        }, 3000);
                    }
                    reject(error);
                });
            } catch (error) {
                console.error('Sign in error:', error);
                reject(error);
            }
        });
    }

    function handleAuthStateChange(user) {
        return new Promise(function(resolve, reject) {
            try {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.uid);
                    
                    if (isOnline) {
                        updateSyncStatus('syncing');
                        // First sync data, THEN set up listeners
                        syncFromFirebase().then(() => {
                            // Set up listeners after initial sync is complete
                            setTimeout(() => {
                                setupRealtimeSync();
                            }, 500);
                            resolve();
                        }).catch(reject);
                    } else {
                        resolve();
                    }
                } else {
                    resolve();
                }
            } catch (error) {
                reject(error);
            }
        });
    }

    // Add tracking to prevent multiple listener setups
    let isListenerSetup = false;
    let currentListenerYear = null;

    function setupRealtimeSync() {
        // Prevent multiple setups for the same year
        if (isListenerSetup && currentListenerYear === currentAcademicYear) {
            console.log('Realtime sync already set up for year:', currentAcademicYear);
            return;
        }
        
        console.log('Setting up realtime sync for year:', currentAcademicYear);
        
        // Clean up existing listeners
        cleanupListeners();
        
        const db = firebase.firestore();
        const yearKey = currentAcademicYear.replace('-', '_');
        
        // Term 1 listener
        unsubscribeTerm1 = db.collection('studentFees')
            .doc(`term1_${yearKey}`)
            .onSnapshot(
                { includeMetadataChanges: false },
                (doc) => {
                    // Only process if this is for the current academic year
                    if (currentListenerYear !== currentAcademicYear) {
                        console.log('Ignoring snapshot for old year:', currentListenerYear);
                        return;
                    }
                    
                    console.log(`Term 1 snapshot for ${currentAcademicYear}:`, doc.exists);
                    
                    if (doc.exists) {
                        const data = doc.data();
                        if (data && data.students && data.academicYear === currentAcademicYear) {
                            // Check if data is actually different before updating
                            const currentDataString = JSON.stringify(window.term1Students);
                            const newDataString = JSON.stringify(data.students);
                            
                            if (currentDataString !== newDataString) {
                                window.term1Students = data.students;
                                saveLocalDataForYear(currentAcademicYear);
                                updateAllUI();
                            }
                            updateSyncStatus('synced');
                        }
                    }
                },
                (error) => {
                    console.error('Term 1 snapshot error:', error);
                    updateSyncStatus('offline');
                }
            );

        // Term 2 listener
        unsubscribeTerm2 = db.collection('studentFees')
            .doc(`term2_${yearKey}`)
            .onSnapshot(
                { includeMetadataChanges: false },
                (doc) => {
                    // Only process if this is for the current academic year
                    if (currentListenerYear !== currentAcademicYear) {
                        console.log('Ignoring Term 2 snapshot for old year:', currentListenerYear);
                        return;
                    }
                    
                    console.log(`Term 2 snapshot for ${currentAcademicYear}:`, doc.exists);
                    
                    if (doc.exists) {
                        const data = doc.data();
                        if (data && data.students && data.academicYear === currentAcademicYear) {
                            // Check if data is actually different before updating
                            const currentDataString = JSON.stringify(window.term2Students);
                            const newDataString = JSON.stringify(data.students);
                            
                            if (currentDataString !== newDataString) {
                                window.term2Students = data.students;
                                saveLocalDataForYear(currentAcademicYear);
                                updateAllUI();
                            }
                            updateSyncStatus('synced');
                        }
                    }
                },
                (error) => {
                    console.error('Term 2 snapshot error:', error);
                    updateSyncStatus('offline');
                }
            );
        
        // Mark as set up
        isListenerSetup = true;
        currentListenerYear = currentAcademicYear;
        console.log('Realtime listeners established for:', currentAcademicYear);
    }

    function cleanupListeners() {
        if (unsubscribeTerm1) {
            console.log('Cleaning up Term 1 listener');
            unsubscribeTerm1();
            unsubscribeTerm1 = null;
        }
        
        if (unsubscribeTerm2) {
            console.log('Cleaning up Term 2 listener');
            unsubscribeTerm2();
            unsubscribeTerm2 = null;
        }
        
        isListenerSetup = false;
        currentListenerYear = null;
    }

    function syncFromFirebase() {
        return new Promise(function(resolve, reject) {
            if (!currentUser || !isOnline || isSyncing) {
                resolve();
                return;
            }
            
            isSyncing = true;
            updateSyncStatus('syncing');
            
            try {
                console.log('Starting sync from Firebase...');
                
                const db = firebase.firestore();
                const yearKey = currentAcademicYear.replace('-', '_');
                
                // Use Promise.all to load both terms simultaneously
                Promise.all([
                    db.collection('studentFees').doc(`term1_${yearKey}`).get({ source: 'server' }),
                    db.collection('studentFees').doc(`term2_${yearKey}`).get({ source: 'server' })
                ]).then(function([term1Doc, term2Doc]) {
                    let dataChanged = false;
                    
                    if (term1Doc.exists) {
                        const data = term1Doc.data();
                        if (data && data.students) {
                            window.term1Students = data.students;
                            dataChanged = true;
                        }
                    }
                    
                    if (term2Doc.exists) {
                        const data = term2Doc.data();
                        if (data && data.students) {
                            window.term2Students = data.students;
                            dataChanged = true;
                        }
                    }
                    
                    if (dataChanged) {
                        saveLocalDataForYear(currentAcademicYear);
                        updateAllUI();
                    }
                    
                    updateSyncStatus('synced');
                    console.log('Sync completed successfully');
                    isSyncing = false;
                    resolve();
                }).catch(function(error) {
                    console.error('Sync error:', error);
                    updateSyncStatus('offline');
                    isSyncing = false;
                    reject(error);
                });
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('offline');
                isSyncing = false;
                reject(error);
            }
        });
    }

    function saveToFirebase(year, term, retryCount = 0) {
        return new Promise(function(resolve, reject) {
            if (!currentUser || !isOnline) {
                console.log('Cannot save: no user or offline');
                saveLocalDataForYear(year);
                resolve();
                return;
            }
            
            if (window.savingToFirebase && retryCount === 0) {
                console.log('Save already in progress, skipping');
                resolve();
                return;
            }
            
            window.savingToFirebase = true;
            isSyncing = true;
            updateSyncStatus('syncing');
            
            try {
                const students = term === 'term1' ? window.term1Students : window.term2Students;
                const yearKey = year.replace('-', '_');
                const docId = `${term}_${yearKey}`;
                
                const db = firebase.firestore();
                
                // Clean the data
                const cleanStudents = students.map(function(student) {
                    const cleanStudent = {};
                    Object.keys(student).forEach(function(key) {
                        if (student[key] !== undefined) {
                            cleanStudent[key] = student[key];
                        }
                    });
                    return cleanStudent;
                });
                
                // Try to save with retry logic
                db.collection('studentFees').doc(docId).set({
                    students: cleanStudents,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid,
                    term: term,
                    academicYear: year
                }, { merge: false }).then(function() {
                    console.log(term + ' saved to Firebase successfully for year', year);
                    
                    setTimeout(function() {
                        updateSyncStatus('synced');
                        isSyncing = false;
                        window.savingToFirebase = false;
                        resolve();
                    }, 500);
                    
                }).catch(function(error) {
                    console.error('Firebase save error:', error);
                    
                    // Retry logic - try up to 3 times
                    if (retryCount < 2) {
                        console.log(`Retrying save (attempt ${retryCount + 2}/3)...`);
                        window.savingToFirebase = false;
                        
                        setTimeout(() => {
                            saveToFirebase(year, term, retryCount + 1)
                                .then(resolve)
                                .catch(reject);
                        }, 2000 * (retryCount + 1)); // Increasing delay
                        
                    } else {
                        // All retries failed
                        console.error('All save attempts failed for ' + term + ' year ' + year);
                        updateSyncStatus('offline');
                        isSyncing = false;
                        window.savingToFirebase = false;
                        
                        // Ensure data is saved locally
                        saveLocalDataForYear(year);
                        
                        // Resolve anyway since data is saved locally
                        resolve();
                    }
                });
                
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('offline');
                isSyncing = false;
                window.savingToFirebase = false;
                saveLocalDataForYear(year);
                resolve(); // Don't reject, data is safe locally
            }
        });
    }

    function manualSync() {
        if (!currentUser || !isOnline) {
            alert('Cannot sync: No internet connection or not authenticated');
            return;
        }
        
        if (isSyncing) {
            alert('Sync already in progress');
            return;
        }
        
        updateSyncStatus('syncing');
        
        Promise.all([
            saveToFirebase(currentAcademicYear, 'term1'),
            saveToFirebase(currentAcademicYear, 'term2')
        ]).then(() => {
            alert('Manual sync completed successfully');
            updateSyncStatus('synced');
        }).catch((error) => {
            console.error('Manual sync failed:', error);
            alert('Manual sync failed. Data remains saved locally.');
            updateSyncStatus('offline');
        });
    }

    function handleOfflineMode() {
        console.log('Running in offline mode');
        updateSyncStatus('offline');
        isSyncing = false;
    }

    function setupNetworkMonitoring() {
        window.addEventListener('online', function() {
            console.log('Network: online');
            isOnline = true;
            
            if (!currentUser) {
                signInUser().catch(function(error) {
                    console.error('Sign in failed after going online:', error);
                });
            } else {
                updateSyncStatus('syncing');
                syncFromFirebase().catch(function(error) {
                    console.error('Sync failed after going online:', error);
                });
            }
        });

        window.addEventListener('offline', function() {
            console.log('Network: offline');
            isOnline = false;
            handleOfflineMode();
        });
    }

    function saveLocalData() {
        saveLocalDataForYear(currentAcademicYear);
    }

    function loadLocalData() {
        loadDataForYear(currentAcademicYear);
    }

    function updateSyncStatus(status) {
        const syncEl = document.getElementById('syncStatus');
        if (!syncEl) return;
        
        const dotEl = syncEl.querySelector('.sync-dot');
        const textEl = syncEl.querySelector('span');
        
        syncEl.className = `sync-status ${status}`;
        if (dotEl) dotEl.className = `sync-dot ${status}`;
        
        // Make it clickable for manual sync
        syncEl.style.cursor = 'pointer';
        syncEl.onclick = function() {
            if (status === 'offline' || status === 'synced') {
                manualSync();
            }
        };
        
        if (textEl) {
            switch(status) {
                case 'syncing':
                    textEl.textContent = 'Syncing...';
                    break;
                case 'synced':
                    textEl.textContent = 'Synced (click to refresh)';
                    break;
                default:
                    textEl.textContent = 'Offline (click to retry)';
            }
        }
        
        console.log('Sync status:', status);
    }

    // UI Functions
    function switchView(view) {
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        
        // Find and activate the correct nav item
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            const onclick = tab.getAttribute('onclick');
            if (onclick && onclick.includes(`'${view}'`)) {
                tab.classList.add('active');
            }
        });
        
        // Update active view
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        
        // Handle view mapping
        let targetView = view;
        if (view === 'term1') {
            targetView = 'term1View';
            currentTerm = 'term1';
        } else if (view === 'term2') {
            targetView = 'term2View';
            currentTerm = 'term2';
        } else if (view === 'overview') {
            targetView = 'overviewView';
        } else if (view === 'reports') {
            targetView = 'reportsView';
        } else if (view === 'analytics') {
            targetView = 'analyticsView';
            updateAnalytics();
        }
        
        const targetElement = document.getElementById(targetView);
        if (targetElement) {
            targetElement.classList.add('active');
        }
    }

    function updateAllUI() {
        try {
            console.log('Updating all UI...');
            
            updateTermStats('term1');
            updateTermStats('term2');
            updateOverviewStats();
            renderStudentsTable('term1');
            renderStudentsTable('term2');
            
            console.log('UI updated successfully');
        } catch (error) {
            console.error('Error updating UI:', error);
        }
    }

    function updateTermStats(term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const activeStudents = students.filter(s => s.studentStatus !== 'left');
        
        const totalStudents = activeStudents.length;
        const fullyPaid = activeStudents.filter(s => getOutstandingAmount(s, term) === 0).length;
        const partiallyPaid = activeStudents.filter(s => {
            const paid = getTotalPaid(s);
            const outstanding = getOutstandingAmount(s, term);
            return paid > 0 && outstanding > 0;
        }).length;
        const totalOutstanding = activeStudents.reduce((sum, s) => sum + getOutstandingAmount(s, term), 0);
        
        const totalEl = document.getElementById(`${term}TotalStudents`);
        const fullyPaidEl = document.getElementById(`${term}FullyPaid`);
        const partiallyPaidEl = document.getElementById(`${term}PartiallyPaid`);
        const outstandingEl = document.getElementById(`${term}Outstanding`);
        
        if (totalEl) totalEl.textContent = totalStudents;
        if (fullyPaidEl) fullyPaidEl.textContent = fullyPaid;
        if (partiallyPaidEl) partiallyPaidEl.textContent = partiallyPaid;
        if (outstandingEl) outstandingEl.textContent = formatCurrency(totalOutstanding);
    }

    function updateOverviewStats() {
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        
        const uniqueStudents = activeStudents.reduce((acc, student) => {
            const key = `${student.firstName}_${student.lastName}_${student.dob}`;
            if (!acc[key]) {
                acc[key] = student;
            }
            return acc;
        }, {});
        
        const totalStudents = Object.keys(uniqueStudents).length;
        const totalRevenue = activeStudents.reduce((sum, s) => sum + getTotalPaid(s), 0);
        const totalOutstanding = activeStudents.reduce((sum, s) => sum + getOutstandingAmount(s, s.term || 'term1'), 0);
        const totalFees = activeStudents.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0) + (parseFloat(s.vat) || 0), 0);
        const collectionRate = totalFees > 0 ? (totalRevenue / totalFees * 100) : 0;
        
        // VAT Calculations - Fixed logic: payments fill set fee first, then VAT
        const totalVATSet = activeStudents.reduce((sum, s) => sum + (parseFloat(s.vat) || 0), 0);
        const vatCollected = activeStudents.reduce((sum, s) => {
            const payments = s.payments || [];
            const totalPaid = payments.reduce((pSum, p) => pSum + (parseFloat(p.amount) || 0), 0);
            const setFee = parseFloat(s.setFee) || 0;
            const vatAmount = parseFloat(s.vat) || 0;
            
            if (vatAmount <= 0) return sum;
            
            // Payments fill set fee first, then VAT
            if (totalPaid <= setFee) {
                // Payment hasn't covered set fee yet, no VAT collected
                return sum;
            } else {
                // Payment exceeds set fee, calculate VAT collected
                const excessPayment = totalPaid - setFee;
                const vatCollectedForStudent = Math.min(excessPayment, vatAmount);
                return sum + vatCollectedForStudent;
            }
        }, 0);
        const vatOutstanding = totalVATSet - vatCollected;
        
        const overviewTotalStudentsEl = document.getElementById('overviewTotalStudents');
        const overviewTotalRevenueEl = document.getElementById('overviewTotalRevenue');
        const overviewTotalOutstandingEl = document.getElementById('overviewTotalOutstanding');
        const overviewCollectionRateEl = document.getElementById('overviewCollectionRate');
        
        if (overviewTotalStudentsEl) overviewTotalStudentsEl.textContent = totalStudents;
        if (overviewTotalRevenueEl) overviewTotalRevenueEl.textContent = formatCurrency(totalRevenue);
        if (overviewTotalOutstandingEl) overviewTotalOutstandingEl.textContent = formatCurrency(totalOutstanding);
        if (overviewCollectionRateEl) overviewCollectionRateEl.textContent = collectionRate.toFixed(1) + '%';
        
        // Update VAT elements
        const overviewTotalVATSetEl = document.getElementById('overviewTotalVATSet');
        const overviewVATCollectedEl = document.getElementById('overviewVATCollected');
        const overviewVATOutstandingEl = document.getElementById('overviewVATOutstanding');
        const overviewVATLiabilityEl = document.getElementById('overviewVATLiability');
        
        if (overviewTotalVATSetEl) overviewTotalVATSetEl.textContent = formatCurrency(totalVATSet);
        if (overviewVATCollectedEl) overviewVATCollectedEl.textContent = formatCurrency(vatCollected);
        if (overviewVATOutstandingEl) overviewVATOutstandingEl.textContent = formatCurrency(vatOutstanding);
        if (overviewVATLiabilityEl) overviewVATLiabilityEl.textContent = formatCurrency(totalVATSet);
        
        // Update term summaries
        const term1ActiveStudents = window.term1Students.filter(s => s.studentStatus !== 'left');
        const term1TotalFees = term1ActiveStudents.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0) + (parseFloat(s.vat) || 0), 0);
        const term1Outstanding = term1ActiveStudents.reduce((sum, s) => sum + getOutstandingAmount(s, 'term1'), 0);
        
        const term1SummaryCountEl = document.getElementById('term1SummaryCount');
        const term1SummaryFeesEl = document.getElementById('term1SummaryFees');
        const term1SummaryOutstandingEl = document.getElementById('term1SummaryOutstanding');
        
        if (term1SummaryCountEl) term1SummaryCountEl.textContent = term1ActiveStudents.length;
        if (term1SummaryFeesEl) term1SummaryFeesEl.textContent = formatCurrency(term1TotalFees);
        if (term1SummaryOutstandingEl) term1SummaryOutstandingEl.textContent = formatCurrency(term1Outstanding);
        
        const term2ActiveStudents = window.term2Students.filter(s => s.studentStatus !== 'left');
        const term2TotalFees = term2ActiveStudents.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0) + (parseFloat(s.vat) || 0), 0);
        const term2Outstanding = term2ActiveStudents.reduce((sum, s) => sum + getOutstandingAmount(s, 'term2'), 0);
        
        const term2SummaryCountEl = document.getElementById('term2SummaryCount');
        const term2SummaryFeesEl = document.getElementById('term2SummaryFees');
        const term2SummaryOutstandingEl = document.getElementById('term2SummaryOutstanding');
        
        if (term2SummaryCountEl) term2SummaryCountEl.textContent = term2ActiveStudents.length;
        if (term2SummaryFeesEl) term2SummaryFeesEl.textContent = formatCurrency(term2TotalFees);
        if (term2SummaryOutstandingEl) term2SummaryOutstandingEl.textContent = formatCurrency(term2Outstanding);
    }

    function renderStudentsTable(term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const tableBody = document.getElementById(`${term}StudentsTable`);
        
        if (!tableBody) return;
        
        if (students.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="13">
                        <div class="empty-state">
                            <div class="icon">ðŸŽ“</div>
                            <div class="title">No students added yet</div>
                            <div class="subtitle">Click the + button to add your first student</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Sort students by year group (youngest to eldest) then by last name
        const sortedStudents = sortStudentsByYear([...students]);
        
        tableBody.innerHTML = sortedStudents.map((student, index) => {
            const totalPaid = getTotalPaid(student);
            const outstanding = getOutstandingAmount(student, term);
            const status = getPaymentStatus(student, term);
            const discountText = getDiscountText(student);
            const studentStatus = student.studentStatus || 'active';
            const isSelected = selectedStudents[term].has(student.id);
            const dobFormatted = formatDateToUK(student.dob);
            
            return `
                <tr style="${studentStatus === 'left' ? 'opacity: 0.6;' : ''}">
                    <td>
                        <input type="checkbox" class="student-checkbox" data-student-id="${student.id}" 
                               onchange="toggleStudentSelection('${student.id}', '${term}')" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${index + 1}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${dobFormatted}</td>
                    <td>Year ${student.year}</td>
                    <td>${formatCurrency(parseFloat(student.setFee) || 0)}</td>
                    <td>${formatCurrency(parseFloat(student.vat) || 0)}</td>
                    <td>${formatCurrency(totalPaid)}</td>
                    <td>${formatCurrency(outstanding)}</td>
                    <td><span class="payment-status ${studentStatus === 'left' ? 'left' : status}"><span class="dot"></span>${studentStatus === 'left' ? 'Left' : status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                    <td><span class="payment-status ${studentStatus}">${studentStatus === 'left' ? 'ðŸ“¤ Left' : 'âœ… Active'}</span></td>
                    <td>${discountText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewStudent('${student.id}', '${term}')">View</button>
                            <button class="btn btn-success btn-sm" onclick="showAddPayment('${student.id}', '${term}')">Add Payment</button>
                            <button class="btn btn-secondary btn-sm" onclick="editStudent('${student.id}', '${term}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}', '${term}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Update select all checkbox state
        updateSelectAllCheckbox(term);
        updateBulkActionsUI(term);
    }

    function setupSearchFilters() {
        const term1Search = document.getElementById('term1Search');
        const term2Search = document.getElementById('term2Search');
        
        if (term1Search) {
            term1Search.addEventListener('input', (e) => {
                const filterEl = document.getElementById('term1Filter');
                filterStudents('term1', e.target.value, filterEl ? filterEl.value : 'all');
            });
        }
        
        if (term2Search) {
            term2Search.addEventListener('input', (e) => {
                const filterEl = document.getElementById('term2Filter');
                filterStudents('term2', e.target.value, filterEl ? filterEl.value : 'all');
            });
        }
    }

    function applyFilter(term) {
        const searchEl = document.getElementById(`${term}Search`);
        const filterEl = document.getElementById(`${term}Filter`);
        const searchTerm = searchEl ? searchEl.value : '';
        const filterType = filterEl ? filterEl.value : 'all';
        filterStudents(term, searchTerm, filterType);
    }

    function filterStudents(term, searchTerm, filterType) {
        const table = document.getElementById(`${term}StudentsTable`);
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            if (row.querySelector('.empty-state')) return;
            
            const name = row.children[2]?.textContent.toLowerCase() || '';
            const year = row.children[4]?.textContent.toLowerCase() || '';
            const statusCell = row.children[9]; // Payment status column
            const studentStatusCell = row.children[10]; // Student status column
            const outstandingCell = row.children[8]; // Outstanding column
            
            const status = statusCell?.textContent.toLowerCase() || '';
            const studentStatus = studentStatusCell?.textContent.toLowerCase() || '';
            
            // Search filter
            const matchesSearch = name.includes(searchTerm.toLowerCase()) || 
                                year.includes(searchTerm.toLowerCase());
            
            // Type filter
            let matchesFilter = true;
            if (filterType !== 'all' && filterType !== '') {
                switch (filterType) {
                    case 'paid':
                        // Fix: Check for "paid" status but NOT "partial" or "unpaid"
                        matchesFilter = status.includes('paid') && !status.includes('unpaid') && !status.includes('partial');
                        break;
                    case 'partial':
                        matchesFilter = status.includes('partial');
                        break;
                    case 'unpaid':
                        matchesFilter = status.includes('unpaid');
                        break;
                    case 'active':
                        matchesFilter = studentStatus.includes('active');
                        break;
                    case 'left':
                        matchesFilter = studentStatus.includes('left');
                        break;
                    case 'outstanding':
                        const outstanding = parseFloat(outstandingCell?.textContent.replace(/[Â£,]/g, '') || '0');
                        matchesFilter = outstanding > 0;
                        break;
                    // Year group filters
                    case 'year7':
                        matchesFilter = year.includes('year 7');
                        break;
                    case 'year8':
                        matchesFilter = year.includes('year 8');
                        break;
                    case 'year9':
                        matchesFilter = year.includes('year 9');
                        break;
                    case 'year10':
                        matchesFilter = year.includes('year 10');
                        break;
                    case 'year11':
                        matchesFilter = year.includes('year 11');
                        break;
                    case 'year16+':
                        matchesFilter = year.includes('year 16+');
                        break;
                    case 'year18+':
                        matchesFilter = year.includes('year 18+');
                        break;
                    case 'year19+':
                        matchesFilter = year.includes('year 19+');
                        break;
                    default:
                        matchesFilter = true;
                }
            }
            
            row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
        });
        
        // Update select all checkbox after filtering
        updateSelectAllCheckbox(term);
    }

    // Modal Functions
    function showAddStudent() {
        currentStudentId = null;
        
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) {
            modalTitle.textContent = `Add Student - ${currentTerm === 'term1' ? 'Term 1' : 'Term 2'}`;
        }
        
        // Reset form
        const studentForm = document.getElementById('studentForm');
        if (studentForm) {
            studentForm.reset();
        }
        resetPaymentsContainer();
        
        // Set default status to active
        const activeRadio = document.getElementById('statusActive');
        if (activeRadio) {
            activeRadio.checked = true;
        }
        
        const modal = document.getElementById('studentModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    // View student functionality
    function viewStudent(studentId, term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const student = students.find(s => s.id === studentId);
        
        if (!student) return;
        
        currentViewStudentId = studentId;
        currentViewTerm = term;
        
        // Populate modal with student data
        populateStudentViewModal(student, term);
        
        // Show modal
        const modal = document.getElementById('studentViewModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    function populateStudentViewModal(student, term) {
        // Basic information
        const viewStudentName = document.getElementById('viewStudentName');
        const viewStudentDOB = document.getElementById('viewStudentDOB');
        const viewStudentYear = document.getElementById('viewStudentYear');
        const viewStudentTerm = document.getElementById('viewStudentTerm');
        const viewStudentStatus = document.getElementById('viewStudentStatus');
        const viewStudentCreated = document.getElementById('viewStudentCreated');
        const viewStudentUpdated = document.getElementById('viewStudentUpdated');
        
        if (viewStudentName) viewStudentName.textContent = `${student.firstName} ${student.lastName}`;
        if (viewStudentDOB) viewStudentDOB.textContent = formatDateToUK(student.dob);
        if (viewStudentYear) viewStudentYear.textContent = `Year ${student.year}`;
        if (viewStudentTerm) viewStudentTerm.textContent = term === 'term1' ? 'Term 1' : 'Term 2';
        if (viewStudentStatus) {
            const status = student.studentStatus || 'active';
            viewStudentStatus.textContent = status === 'left' ? 'Left School' : 'Active';
            viewStudentStatus.style.color = status === 'left' ? 'var(--warning)' : 'var(--success)';
        }
        if (viewStudentCreated && student.createdAt) {
            viewStudentCreated.textContent = formatDateToUK(student.createdAt);
        } else if (viewStudentCreated) {
            viewStudentCreated.textContent = 'Not available';
        }
        if (viewStudentUpdated && student.updatedAt) {
            viewStudentUpdated.textContent = formatDateToUK(student.updatedAt);
        } else if (viewStudentUpdated) {
            viewStudentUpdated.textContent = 'Not available';
        }
        
        // Comments
        const viewStudentCommentsText = document.getElementById('viewStudentCommentsText');
        if (viewStudentCommentsText) {
            viewStudentCommentsText.textContent = student.comments || 'No comments available';
        }
        
        // Discount information
        const viewStudentDiscountText = document.getElementById('viewStudentDiscountText');
        if (viewStudentDiscountText) {
            if (student.discount && student.discount.type !== 'none') {
                const discountAmount = calculateDiscount(student);
                let discountText = '';
                if (student.discount.type === 'percentage') {
                    discountText = `${student.discount.value}% discount (${formatCurrency(discountAmount)})`;
                } else if (student.discount.type === 'fixed') {
                    discountText = `Fixed discount of ${formatCurrency(discountAmount)}`;
                }
                if (student.discount.siblingNames) {
                    discountText += ` - Siblings: ${student.discount.siblingNames}`;
                }
                viewStudentDiscountText.textContent = discountText;
            } else {
                viewStudentDiscountText.textContent = 'No sibling discount applied';
            }
        }
        
        // Financial summary
        const setFee = parseFloat(student.setFee) || 0;
        const vat = parseFloat(student.vat) || 0;
        const totalFee = setFee + vat;
        const discountAmount = calculateDiscount(student);
        const afterDiscount = totalFee - discountAmount;
        const totalPaid = getTotalPaid(student);
        const outstanding = getOutstandingAmount(student, term);
        
        const viewSetFee = document.getElementById('viewSetFee');
        const viewVAT = document.getElementById('viewVAT');
        const viewTotalFee = document.getElementById('viewTotalFee');
        const viewDiscountAmount = document.getElementById('viewDiscountAmount');
        const viewAfterDiscount = document.getElementById('viewAfterDiscount');
        const viewTotalPaid = document.getElementById('viewTotalPaid');
        const viewOutstandingAmount = document.getElementById('viewOutstandingAmount');
        
        if (viewSetFee) viewSetFee.textContent = formatCurrency(setFee);
        if (viewVAT) viewVAT.textContent = formatCurrency(vat);
        if (viewTotalFee) viewTotalFee.textContent = formatCurrency(totalFee);
        if (viewDiscountAmount) viewDiscountAmount.textContent = `-${formatCurrency(discountAmount)}`;
        if (viewAfterDiscount) viewAfterDiscount.textContent = formatCurrency(afterDiscount);
        if (viewTotalPaid) viewTotalPaid.textContent = formatCurrency(totalPaid);
        if (viewOutstandingAmount) {
            viewOutstandingAmount.textContent = formatCurrency(outstanding);
            viewOutstandingAmount.style.color = outstanding > 0 ? '#FF3B30' : '#34C759';
        }
        
        // Payment history
        const payments = student.payments || [];
        const viewPaymentCount = document.getElementById('viewPaymentCount');
        const viewPaymentsTable = document.getElementById('viewPaymentsTable');
        const viewPaymentsBody = document.getElementById('viewPaymentsBody');
        const viewNoPayments = document.getElementById('viewNoPayments');
        
        if (viewPaymentCount) {
            viewPaymentCount.textContent = `${payments.length} ${payments.length === 1 ? 'payment' : 'payments'}`;
        }
        
        if (payments.length > 0) {
            if (viewPaymentsTable) viewPaymentsTable.style.display = 'table';
            if (viewNoPayments) viewNoPayments.style.display = 'none';
            
            if (viewPaymentsBody) {
                viewPaymentsBody.innerHTML = payments.map((payment, index) => {
                    const paymentDate = payment.date ? formatDateToUK(payment.date) : 'Not specified';
                    const amount = parseFloat(payment.amount) || 0;
                    const invoice = payment.invoice || 'N/A';
                    const method = payment.method || 'Not specified';
                    
                    return `
                        <tr>
                            <td>${paymentDate}</td>
                            <td style="font-weight: 600; color: var(--success);">${formatCurrency(amount)}</td>
                            <td>${invoice}</td>
                            <td><span class="payment-method-badge">${method}</span></td>
                            <td>
                                <button class="btn btn-danger btn-sm" 
                                        onclick="deletePayment(${index}, '${term}')" 
                                        title="Delete this payment">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } else {
            if (viewPaymentsTable) viewPaymentsTable.style.display = 'none';
            if (viewNoPayments) viewNoPayments.style.display = 'block';
        }
    }

    function editStudentFromView() {
        if (currentViewStudentId && currentViewTerm) {
            closeModal('studentViewModal');
            editStudent(currentViewStudentId, currentViewTerm);
        }
    }

    // Add Payment functionality
    function showAddPayment(studentId, term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const student = students.find(s => s.id === studentId);
        
        if (!student) return;
        
        currentPaymentStudentId = studentId;
        currentPaymentTerm = term;
        
        // Populate student info
        const paymentStudentName = document.getElementById('paymentStudentName');
        const paymentStudentTerm = document.getElementById('paymentStudentTerm');
        const paymentStudentYear = document.getElementById('paymentStudentYear');
        const paymentStudentOutstanding = document.getElementById('paymentStudentOutstanding');
        
        if (paymentStudentName) paymentStudentName.textContent = `${student.firstName} ${student.lastName}`;
        if (paymentStudentTerm) paymentStudentTerm.textContent = term === 'term1' ? 'Term 1' : 'Term 2';
        if (paymentStudentYear) paymentStudentYear.textContent = `Year ${student.year}`;
        if (paymentStudentOutstanding) {
            const outstanding = getOutstandingAmount(student, term);
            paymentStudentOutstanding.textContent = formatCurrency(outstanding);
        }
        
        // Reset form
        const addPaymentForm = document.getElementById('addPaymentForm');
        if (addPaymentForm) {
            addPaymentForm.reset();
        }
        
        // Set today's date as default in UK format
        setTodayInUKFormat('paymentDate');
        
        // Show modal
        const modal = document.getElementById('addPaymentModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    function savePayment(event) {
        event.preventDefault();
        
        if (!currentPaymentStudentId || !currentPaymentTerm) return;
        
        // Get form data
        const amount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
        const dateUK = document.getElementById('paymentDate')?.value || '';
        const invoice = document.getElementById('paymentInvoice')?.value || '';
        const method = document.getElementById('paymentMethod')?.value || '';
        
        if (amount <= 0) {
            alert('Please enter a valid payment amount');
            return;
        }
        
        if (!dateUK) {
            alert('Please select a payment date');
            return;
        }
        
        if (!method) {
            alert('Please select a payment method');
            return;
        }
        
        // Validate UK date format
        if (!dateUK.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            alert('Please enter date in DD/MM/YYYY format');
            return;
        }
        
        // Find the student
        const students = currentPaymentTerm === 'term1' ? window.term1Students : window.term2Students;
        const studentIndex = students.findIndex(s => s.id === currentPaymentStudentId);
        
        if (studentIndex === -1) return;
        
        // DISABLE LISTENERS TEMPORARILY to prevent conflicts
        const wasListenerActive = isListenerSetup;
        if (wasListenerActive) {
            cleanupListeners();
        }
        
        // Add payment to student
        if (!students[studentIndex].payments) {
            students[studentIndex].payments = [];
        }
        
        students[studentIndex].payments.push({
            amount: amount,
            date: dateUK,
            invoice: invoice,
            method: method,
            createdAt: formatDateToUK(new Date())
        });
        
        // Update student's last updated time
        students[studentIndex].updatedAt = formatDateToUK(new Date());
        
        // Save locally first
        saveLocalData();
        
        // Update UI immediately
        updateAllUI();
        closeModal('addPaymentModal');
        
        // Save to Firebase with conflict prevention
        saveToFirebase(currentAcademicYear, currentPaymentTerm).then(() => {
            console.log('Payment saved successfully');
            
            // Re-enable listeners after successful save
            if (wasListenerActive && currentUser && isOnline) {
                setTimeout(() => {
                    setupRealtimeSync();
                }, 2000);
            }
            
            // Show success message
            alert(`Payment of ${formatCurrency(amount)} added successfully for ${students[studentIndex].firstName} ${students[studentIndex].lastName}`);
        }).catch((error) => {
            console.error('Error saving payment:', error);
            
            // Re-enable listeners even on error
            if (wasListenerActive && currentUser && isOnline) {
                setTimeout(() => {
                    setupRealtimeSync();
                }, 2000);
            }
            
            alert(`Payment of ${formatCurrency(amount)} added successfully for ${students[studentIndex].firstName} ${students[studentIndex].lastName}.\n\nNote: Payment saved locally. Will sync to cloud when connection improves.`);
        });
    }

    function editStudent(studentId, term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const student = students.find(s => s.id === studentId);
        
        if (!student) return;
        
        currentTerm = term;
        currentStudentId = studentId;
        
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) {
            modalTitle.textContent = `Edit Student - ${term === 'term1' ? 'Term 1' : 'Term 2'}`;
        }
        
        // Fill form fields
        const studentFirstName = document.getElementById('studentFirstName');
        const studentLastName = document.getElementById('studentLastName');
        const studentDOB = document.getElementById('studentDOB');
        const studentYear = document.getElementById('studentYear');
        const studentFee = document.getElementById('studentFee');
        const studentVAT = document.getElementById('studentVAT');
        const studentComments = document.getElementById('studentComments');
        
        if (studentFirstName) studentFirstName.value = student.firstName || '';
        if (studentLastName) studentLastName.value = student.lastName || '';
        if (studentDOB) studentDOB.value = formatDateToUK(student.dob);
        if (studentYear) studentYear.value = student.year || '';
        if (studentFee) studentFee.value = student.setFee || 0;
        if (studentVAT) studentVAT.value = student.vat || 0;
        if (studentComments) studentComments.value = student.comments || '';
        
        // Set student status
        const studentStatus = student.studentStatus || 'active';
        const statusRadio = document.getElementById(studentStatus === 'left' ? 'statusLeft' : 'statusActive');
        if (statusRadio) {
            statusRadio.checked = true;
        }
        
        // Fill discount
        if (student.discount) {
            const discountType = document.getElementById('discountType');
            const discountValue = document.getElementById('discountValue');
            const siblingNames = document.getElementById('siblingNames');
            
            if (discountType) discountType.value = student.discount.type || 'none';
            if (discountValue) discountValue.value = student.discount.value || 0;
            if (siblingNames) siblingNames.value = student.discount.siblingNames || '';
        }
        
        // Fill payments
        resetPaymentsContainer();
        if (student.payments && student.payments.length > 0) {
            student.payments.forEach((payment, index) => {
                if (index > 0) addPaymentEntry();
                
                const container = document.getElementById('paymentsContainer');
                if (container) {
                    const entries = container.querySelectorAll('.payment-row');
                    const entry = entries[index];
                    
                    if (entry) {
                        const amountInput = entry.querySelector('input[name="paymentAmount[]"]');
                        const invoiceInput = entry.querySelector('input[name="paymentInvoice[]"]');
                        const dateInput = entry.querySelector('input[name="paymentDate[]"]');
                        const methodSelect = entry.querySelector('select[name="paymentMethod[]"]');
                        
                        if (amountInput) amountInput.value = payment.amount || '';
                        if (invoiceInput) invoiceInput.value = payment.invoice || '';
                        if (dateInput) dateInput.value = formatDateToUK(payment.date);
                        if (methodSelect) methodSelect.value = payment.method || '';
                    }
                }
            });
        }
        
        const modal = document.getElementById('studentModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    function deleteStudent(studentId, term) {
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const student = students.find(s => s.id === studentId);
        
        if (!student) return;
        
        if (!confirm(`Are you sure you want to permanently delete ${student.firstName} ${student.lastName}? This action cannot be undone.`)) {
            return;
        }
        
        if (term === 'term1') {
            window.term1Students = window.term1Students.filter(s => s.id !== studentId);
        } else {
            window.term2Students = window.term2Students.filter(s => s.id !== studentId);
        }
        
        // Remove from selections
        selectedStudents[term].delete(studentId);
        
        saveLocalData();
        saveToFirebase(currentAcademicYear, term);
        updateAllUI();
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function addPaymentEntry() {
        const container = document.getElementById('paymentsContainer');
        if (!container) return;
        
        const entryId = 'paymentDate_' + Date.now();
        const newEntry = document.createElement('div');
        newEntry.className = 'payment-row';
        newEntry.innerHTML = `
            <div class="form-group">
                <label class="form-label">Amount (Â£)</label>
                <input type="number" step="0.01" class="form-input" name="paymentAmount[]">
            </div>
            <div class="form-group">
                <label class="form-label">Invoice No.</label>
                <input type="text" class="form-input" name="paymentInvoice[]">
            </div>
            <div class="form-group">
                <label class="form-label">Date (DD/MM/YYYY)</label>
                <div style="position: relative;">
                    <input type="text" 
                           class="form-input date-input" 
                           name="paymentDate[]" 
                           id="${entryId}"
                           placeholder="DD/MM/YYYY" 
                           pattern="\\d{2}/\\d{2}/\\d{4}"
                           maxlength="10"
                           oninput="autoFormatDate(this)"
                           style="padding-right: 40px;">
                    <button type="button" 
                            class="date-picker-btn" 
                            onclick="showDatePicker('${entryId}')"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                   background: none; border: none; cursor: pointer; font-size: 16px; 
                                   color: var(--text-secondary); padding: 4px;">
                        ðŸ“…
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Method</label>
                <select class="form-select" name="paymentMethod[]">
                    <option value="">Select Method</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Card">Card</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
            <div>
                <button type="button" class="delete-payment" onclick="removePaymentEntry(this)">&times;</button>
            </div>
        `;
        container.appendChild(newEntry);
    }

    function removePaymentEntry(button) {
        const entry = button.closest('.payment-row');
        const container = document.getElementById('paymentsContainer');
        
        // Don't remove if it's the only payment entry
        if (container.querySelectorAll('.payment-row').length > 1) {
            entry.remove();
        } else {
            // Clear the fields instead
            entry.querySelectorAll('input, select').forEach(field => {
                field.value = '';
            });
        }
    }

    function resetPaymentsContainer() {
        const container = document.getElementById('paymentsContainer');
        if (!container) return;
        
        const initialEntryId = 'paymentDate_initial';
        container.innerHTML = `
            <div class="payment-row">
                <div class="form-group">
                    <label class="form-label">Amount (Â£)</label>
                    <input type="number" step="0.01" class="form-input" name="paymentAmount[]">
                </div>
                <div class="form-group">
                    <label class="form-label">Invoice No.</label>
                    <input type="text" class="form-input" name="paymentInvoice[]">
                </div>
                <div class="form-group">
                    <label class="form-label">Date (DD/MM/YYYY)</label>
                    <div style="position: relative;">
                        <input type="text" 
                               class="form-input date-input" 
                               name="paymentDate[]" 
                               id="${initialEntryId}"
                               placeholder="DD/MM/YYYY" 
                               pattern="\\d{2}/\\d{2}/\\d{4}"
                               maxlength="10"
                               oninput="autoFormatDate(this)"
                               style="padding-right: 40px;">
                        <button type="button" 
                                class="date-picker-btn" 
                                onclick="showDatePicker('${initialEntryId}')"
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; font-size: 16px; 
                                       color: var(--text-secondary); padding: 4px;">
                            ðŸ“…
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Method</label>
                    <select class="form-select" name="paymentMethod[]">
                        <option value="">Select Method</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <button type="button" class="delete-payment" onclick="removePaymentEntry(this)" style="visibility: hidden;">&times;</button>
                </div>
            </div>
        `;
    }

    function saveStudent(event) {
        event.preventDefault();
        
        // Get student status from radio buttons
        const statusRadios = document.querySelectorAll('input[name="studentStatus"]');
        let studentStatus = 'active';
        statusRadios.forEach(radio => {
            if (radio.checked) {
                studentStatus = radio.value;
            }
        });
        
        // Get and validate DOB
        const dobValue = document.getElementById('studentDOB')?.value || '';
        if (!dobValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            alert('Please enter date of birth in DD/MM/YYYY format');
            return;
        }
        
        const studentData = {
            id: currentStudentId || Date.now().toString(),
            firstName: document.getElementById('studentFirstName')?.value || '',
            lastName: document.getElementById('studentLastName')?.value || '',
            dob: dobValue,
            year: document.getElementById('studentYear')?.value || '',
            setFee: parseFloat(document.getElementById('studentFee')?.value) || 0,
            vat: parseFloat(document.getElementById('studentVAT')?.value) || 0,
            comments: document.getElementById('studentComments')?.value || '',
            studentStatus: studentStatus,
            discount: {
                type: document.getElementById('discountType')?.value || 'none',
                value: parseFloat(document.getElementById('discountValue')?.value) || 0,
                siblingNames: document.getElementById('siblingNames')?.value || ''
            },
            payments: [],
            term: currentTerm,
            academicYear: currentAcademicYear,
            createdAt: currentStudentId ? undefined : formatDateToUK(new Date()),
            updatedAt: formatDateToUK(new Date())
        };

        // Collect payments
        const amountInputs = document.querySelectorAll('input[name="paymentAmount[]"]');
        const invoiceInputs = document.querySelectorAll('input[name="paymentInvoice[]"]');
        const dateInputs = document.querySelectorAll('input[name="paymentDate[]"]');
        const methodSelects = document.querySelectorAll('select[name="paymentMethod[]"]');

        for (let i = 0; i < amountInputs.length; i++) {
            const amount = parseFloat(amountInputs[i].value);
            const dateValue = dateInputs[i].value;
            
            if (amount && amount > 0) {
                // Validate date format if provided
                if (dateValue && !dateValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    alert(`Payment ${i + 1}: Please enter date in DD/MM/YYYY format or leave empty`);
                    return;
                }
                
                studentData.payments.push({
                    amount: amount,
                    invoice: invoiceInputs[i].value,
                    date: dateValue,
                    method: methodSelects[i].value
                });
            }
        }

        // Save to appropriate term
        if (currentTerm === 'term1') {
            if (currentStudentId) {
                const index = window.term1Students.findIndex(s => s.id === currentStudentId);
                if (index !== -1) {
                    window.term1Students[index] = { ...window.term1Students[index], ...studentData };
                }
            } else {
                window.term1Students.push(studentData);
            }
        } else {
            if (currentStudentId) {
                const index = window.term2Students.findIndex(s => s.id === currentStudentId);
                if (index !== -1) {
                    window.term2Students[index] = { ...window.term2Students[index], ...studentData };
                }
            } else {
                window.term2Students.push(studentData);
            }
        }

        saveLocalData();
        saveToFirebase(currentAcademicYear, currentTerm);
        updateAllUI();
        closeModal('studentModal');
    }

    function deletePayment(paymentIndex, term) {
        if (!currentViewStudentId || !currentViewTerm) {
            console.error('No student currently being viewed');
            return;
        }
        
        const students = term === 'term1' ? window.term1Students : window.term2Students;
        const studentIndex = students.findIndex(s => s.id === currentViewStudentId);
        
        if (studentIndex === -1) {
            console.error('Student not found');
            return;
        }
        
        const student = students[studentIndex];
        const payments = student.payments || [];
        
        if (paymentIndex < 0 || paymentIndex >= payments.length) {
            console.error('Invalid payment index');
            return;
        }
        
        const payment = payments[paymentIndex];
        const paymentAmount = parseFloat(payment.amount) || 0;
        const paymentDate = formatDateToUK(payment.date);
        
        // Confirm deletion
        if (!confirm(`Are you sure you want to delete this payment?\n\nAmount: ${formatCurrency(paymentAmount)}\nDate: ${paymentDate}\nMethod: ${payment.method || 'Not specified'}\n\nThis action cannot be undone.`)) {
            return;
        }
        
        // Remove the payment
        students[studentIndex].payments.splice(paymentIndex, 1);
        
        // Update student's last updated time
        students[studentIndex].updatedAt = formatDateToUK(new Date());
        
        // Save and update UI
        saveLocalData();
        saveToFirebase(currentAcademicYear, term);
        updateAllUI();
        
        // Refresh the student view modal with updated data
        populateStudentViewModal(students[studentIndex], term);
        
        alert(`Payment of ${formatCurrency(paymentAmount)} has been deleted successfully.`);
    }

    function updateAnalytics() {
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        
        // Update analytics elements if they exist
        const collectionTrendEl = document.getElementById('collectionTrend');
        const avgPaymentTimeEl = document.getElementById('avgPaymentTime');
        const topPaymentMethodEl = document.getElementById('topPaymentMethod');
        const discountUsageEl = document.getElementById('discountUsage');
        
        // Calculate collection trend (mock data for now)
        if (collectionTrendEl) collectionTrendEl.textContent = '+15%';
        
        // Calculate average payment time (mock data)
        if (avgPaymentTimeEl) avgPaymentTimeEl.textContent = '23 days';
        
        // Find most popular payment method
        const allPayments = activeStudents.flatMap(s => s.payments || []);
        const paymentMethods = {};
        allPayments.forEach(p => {
            const method = p.method || 'Unknown';
            paymentMethods[method] = (paymentMethods[method] || 0) + 1;
        });
        
        const topMethod = Object.entries(paymentMethods).sort(([,a], [,b]) => b - a)[0];
        if (topPaymentMethodEl) topPaymentMethodEl.textContent = topMethod ? topMethod[0] : 'None';
        
        // Calculate discount usage
        const studentsWithDiscount = activeStudents.filter(s => s.discount && s.discount.type !== 'none').length;
        const discountRate = activeStudents.length > 0 ? (studentsWithDiscount / activeStudents.length * 100) : 0;
        if (discountUsageEl) discountUsageEl.textContent = `${discountRate.toFixed(0)}%`;
    }

    // CSV Import Functions
    function setupFileUpload() {
        const uploadArea = document.querySelector('.file-upload-area');
        const fileInput = document.getElementById('csvFileInput');
        
        if (!uploadArea || !fileInput) return;
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleCSVUpload({ target: { files } });
            }
        });
    }

    function showImportModal() {
        const modal = document.getElementById('importModal');
        if (modal) {
            modal.classList.add('active');
        }
    }

    function handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Please upload a CSV file');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                csvData = parseCSV(e.target.result);
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    importBtn.disabled = false;
                }
                
                // Update upload area to show file selected
                const uploadArea = document.querySelector('.file-upload-area');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.6;">âœ…</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${file.name}</div>
                        <div style="color: var(--text-secondary);">${csvData.length} rows found</div>
                    `;
                }
            } catch (error) {
                alert('Error reading CSV file: ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function parseCSV(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length < 2) throw new Error('CSV must have header and data rows');
        
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            if (values.length !== headers.length) continue;
            
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index].trim();
            });
            data.push(row);
        }
        
        return data;
    }

    function processCSVImport() {
        if (!csvData) {
            alert('No CSV data to import');
            return;
        }
        
        const termEl = document.getElementById('importTerm');
        const term = termEl ? termEl.value : 'term1';
        let importedCount = 0;
        
        csvData.forEach(row => {
            try {
                // Handle DOB formatting - ensure it's in DD/MM/YYYY
                let dobFormatted = '';
                const dobValue = row['dob'] || row['date of birth'] || '';
                if (dobValue) {
                    dobFormatted = formatDateToUK(dobValue);
                }
                
                const studentData = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    firstName: row['student name'] || row['first name'] || '',
                    lastName: row['last name'] || '',
                    dob: dobFormatted,
                    year: row['school year'] || row['year'] || '',
                    setFee: parseFloat(row['set fee'] || row['fee'] || 0),
                    vat: parseFloat(row['vat amount'] || row['vat'] || 0),
                    comments: '',
                    studentStatus: 'active',
                    discount: { type: 'none', value: 0, siblingNames: '' },
                    payments: [],
                    term: term,
                    academicYear: currentAcademicYear,
                    createdAt: formatDateToUK(new Date()),
                    updatedAt: formatDateToUK(new Date())
                };
                
                if (studentData.firstName && studentData.lastName) {
                    if (term === 'term1') {
                        window.term1Students.push(studentData);
                    } else {
                        window.term2Students.push(studentData);
                    }
                    importedCount++;
                }
            } catch (error) {
                console.error('Error importing row:', error);
            }
        });
        
        saveLocalData();
        saveToFirebase(currentAcademicYear, term);
        updateAllUI();
        closeModal('importModal');
        
        alert(`Successfully imported ${importedCount} students to ${term === 'term1' ? 'Term 1' : 'Term 2'} for academic year ${currentAcademicYear}`);
    }

    // CSV Export Functions
    function exportToCSV(scope = 'complete') {
        const timestamp = new Date().toISOString().split('T')[0];
        const timeString = new Date().toTimeString().split(' ')[0].replace(/:/g, '');
        
        const csvData = [];
        
        // Headers for complete data
        const headers = [
            'Student ID', 'First Name', 'Last Name', 'Date of Birth', 'Year Group', 'Term',
            'Set Fee', 'VAT', 'Student Status', 'Discount Type', 'Discount Value', 'Sibling Names',
            'Comments', 'Academic Year', 'Created Date', 'Updated Date',
            'Payment 1 Amount', 'Payment 1 Date', 'Payment 1 Method', 'Payment 1 Invoice',
            'Payment 2 Amount', 'Payment 2 Date', 'Payment 2 Method', 'Payment 2 Invoice',
            'Payment 3 Amount', 'Payment 3 Date', 'Payment 3 Method', 'Payment 3 Invoice'
        ];
        
        csvData.push(headers);
        
        // Add all students from both terms
        const allStudents = [
            ...window.term1Students.map(s => ({...s, term: 'Term 1'})),
            ...window.term2Students.map(s => ({...s, term: 'Term 2'}))
        ];
        
        allStudents.forEach(student => {
            const row = [
                student.id,
                student.firstName || '',
                student.lastName || '',
                formatDateToUK(student.dob),
                student.year || '',
                student.term,
                parseFloat(student.setFee) || 0,
                parseFloat(student.vat) || 0,
                student.studentStatus || 'active',
                (student.discount && student.discount.type) || 'none',
                (student.discount && student.discount.value) || 0,
                (student.discount && student.discount.siblingNames) || '',
                student.comments || '',
                student.academicYear || currentAcademicYear,
                formatDateToUK(student.createdAt),
                formatDateToUK(student.updatedAt)
            ];
            
            // Add up to 3 payments
            const payments = student.payments || [];
            for (let i = 0; i < 3; i++) {
                if (payments[i]) {
                    row.push(
                        parseFloat(payments[i].amount) || 0,
                        formatDateToUK(payments[i].date),
                        payments[i].method || '',
                        payments[i].invoice || ''
                    );
                } else {
                    row.push('', '', '', '');
                }
            }
            
            csvData.push(row);
        });
        
        const filename = `DUL_BACKUP_${currentAcademicYear}_${timestamp}.csv`;
        downloadCSV(csvData, filename);
        
        alert('Complete backup downloaded!');
    }

    function downloadCSV(data, filename) {
        // Create CSV content with proper escaping
        const csvContent = data.map(row => 
            row.map(cell => {
                const cellStr = String(cell || '');
                // Escape quotes and wrap in quotes if contains comma, quote, or newline
                if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                    return '"' + cellStr.replace(/"/g, '""') + '"';
                }
                return cellStr;
            }).join(',')
        ).join('\n');
        
        // Add BOM for Excel compatibility
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }

    function showImportCSV() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!confirm('This will replace ALL current data. Continue?')) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const lines = event.target.result.split('\n');
                    
                    window.term1Students = [];
                    window.term2Students = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = parseCSVLine(line);
                        if (values.length < 16) continue;
                        
                        const student = {
                            id: values[0],
                            firstName: values[1],
                            lastName: values[2],
                            dob: values[3],
                            year: values[4],
                            setFee: parseFloat(values[6]) || 0,
                            vat: parseFloat(values[7]) || 0,
                            studentStatus: values[8] || 'active',
                            discount: {
                                type: values[9] || 'none',
                                value: parseFloat(values[10]) || 0,
                                siblingNames: values[11] || ''
                            },
                            comments: values[12] || '',
                            academicYear: values[13] || currentAcademicYear,
                            createdAt: values[14],
                            updatedAt: values[15],
                            payments: []
                        };
                        
                        // Extract payments
                        for (let p = 0; p < 3; p++) {
                            const baseIndex = 16 + (p * 4);
                            const amount = parseFloat(values[baseIndex]);
                            if (amount && amount > 0) {
                                student.payments.push({
                                    amount: amount,
                                    date: values[baseIndex + 1],
                                    method: values[baseIndex + 2],
                                    invoice: values[baseIndex + 3]
                                });
                            }
                        }
                        
                        // Add to correct term
                        if (values[5] === 'Term 1') {
                            window.term1Students.push(student);
                        } else {
                            window.term2Students.push(student);
                        }
                    }
                    
                    saveLocalData();
                    updateAllUI();
                    alert('Data restored successfully!');
                    
                } catch (error) {
                    alert('Import failed: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // PDF Export Functions with improvements
    function exportPDFReport(scope, type) {
        const btnId = scope === 'all' ? `${type}Btn` : `${scope}${type.charAt(0).toUpperCase() + type.slice(1)}Btn`;
        const spinnerId = scope === 'all' ? `${type}Spinner` : `${scope}${type.charAt(0).toUpperCase() + type.slice(1)}Spinner`;
        
        const btn = document.getElementById(btnId);
        const spinner = document.getElementById(spinnerId);
        
        if (btn) btn.disabled = true;
        if (spinner) spinner.style.display = 'block';
        
        try {
            if (typeof window.jspdf === 'undefined') {
                alert('PDF library not loaded. Please refresh the page and try again.');
                resetPDFButton(btnId, spinnerId);
                return;
            }

            const { jsPDF } = window.jspdf;
            
            // Create landscape PDF
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            const reportNotes = document.getElementById('reportNotes')?.value || '';
            
            switch (type) {
                case 'detailed':
                    generateDetailedReport(doc, scope, reportNotes);
                    break;
                case 'outstanding':
                    generateOutstandingReport(doc, scope, reportNotes);
                    break;
                case 'vat':
                    generateVATReport(doc, reportNotes);
                    break;
                case 'summary':
                    generateSummaryReport(doc, reportNotes);
                    break;
                case 'payments':
                    generatePaymentMethodsReport(doc, reportNotes);
                    break;
                case 'yeargroups':
                    generateYearGroupsReport(doc, reportNotes);
                    break;
            }
            
            const scopeName = scope === 'all' ? 'complete_year' : scope;
            const fileName = `${type}_report_${scopeName}_${currentAcademicYear}_${formatDateToUK(new Date()).replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
            
            setTimeout(() => {
                alert(`PDF ${type.charAt(0).toUpperCase() + type.slice(1)} report generated successfully for academic year ${currentAcademicYear}!`);
                resetPDFButton(btnId, spinnerId);
            }, 500);
            
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF: ' + error.message);
            resetPDFButton(btnId, spinnerId);
        }
    }

    function resetPDFButton(btnId, spinnerId) {
        const btn = document.getElementById(btnId);
        const spinner = document.getElementById(spinnerId);
        
        if (btn) btn.disabled = false;
        if (spinner) spinner.style.display = 'none';
    }

    function addPDFHeader(doc, title, notes) {
        // Modern gradient header
        doc.setFillColor(16, 163, 127);
        doc.rect(0, 0, 297, 40, 'F');
        
        // Title
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text(title, 148, 20, { align: 'center' });
        
        // Academic year and date
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Academic Year: ${currentAcademicYear}`, 25, 30);
        doc.text(`Generated: ${formatDateToUK(new Date())}`, 272, 30, { align: 'right' });
        
        // Reset text color for body
        doc.setTextColor(60, 60, 60);
    }

    function addPDFFooter(doc) {
        const pageHeight = doc.internal.pageSize.height;
        
        // Clean footer line
        doc.setDrawColor(16, 163, 127);
        doc.setLineWidth(1);
        doc.line(25, pageHeight - 20, 272, pageHeight - 20);
        
        // Footer text
        doc.setTextColor(120, 120, 120);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('DUL Student Fees Management System', 25, pageHeight - 12);
        doc.text(`Page 1`, 272, pageHeight - 12, { align: 'right' });
        doc.text(`Â© ${new Date().getFullYear()} Darul Uloom London`, 148, pageHeight - 6, { align: 'center' });
    }

    function addSummaryStats(doc, students, scope) {
        // Add summary statistics to PDF
        let yPos = 55;
        
        const totalStudents = students.length;
        const activeStudents = students.filter(s => s.studentStatus !== 'left').length;
        const totalFees = students.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0) + (parseFloat(s.vat) || 0), 0);
        const totalCollected = students.reduce((sum, s) => sum + getTotalPaid(s), 0);
        const totalOutstanding = totalFees - totalCollected;
        
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(25, yPos, 247, 32, 3, 3, 'F');
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('SUMMARY OVERVIEW', 148, yPos + 12, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Students: ${activeStudents}/${totalStudents}`, 35, yPos + 22);
        doc.text(`Total Fees: ${formatCurrency(totalFees)}`, 100, yPos + 22);
        doc.text(`Collected: ${formatCurrency(totalCollected)}`, 170, yPos + 22);
        doc.text(`Outstanding: ${formatCurrency(totalOutstanding)}`, 240, yPos + 22);
    }

    function addStudentTable(doc, students, scope) {
        if (students.length === 0) return;
        
        let yPos = 95;
        
        // Sort students by year group (Year 7 to 19+)
        const sortedStudents = sortStudentsByYear([...students]);
        
        const tableData = sortedStudents.map(student => {
            const collected = getTotalPaid(student);
            const outstanding = getOutstandingAmount(student, student.term || scope);
            const status = student.studentStatus || 'active';
            
            return [
                `${student.firstName} ${student.lastName}`,
                `Year ${student.year}`,
                student.term === 'term1' ? 'Term 1' : 'Term 2',
                formatCurrency(parseFloat(student.setFee) || 0),
                formatCurrency(parseFloat(student.vat) || 0),
                formatCurrency(collected),
                formatCurrency(outstanding),
                status.charAt(0).toUpperCase() + status.slice(1)
            ];
        });
        
        doc.autoTable({
            startY: yPos,
            head: [['Student Name', 'Year', 'Term', 'Set Fee', 'VAT', 'Collected', 'Outstanding', 'Status']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [16, 163, 127],
                textColor: [255, 255, 255],
                fontSize: 9,
                fontStyle: 'bold',
                cellPadding: 3
            },
            bodyStyles: { 
                fontSize: 8,
                cellPadding: 2.5
            },
            columnStyles: {
                0: { cellWidth: 40, fontStyle: 'bold' },
                1: { cellWidth: 20, halign: 'center' },
                2: { cellWidth: 20, halign: 'center' },
                3: { cellWidth: 28, halign: 'right' },
                4: { cellWidth: 23, halign: 'right' },
                5: { cellWidth: 28, halign: 'right', textColor: [52, 199, 89] },
                6: { cellWidth: 30, halign: 'right', textColor: [255, 59, 48], fontStyle: 'bold' },
                7: { cellWidth: 22, halign: 'center' }
            },
            margin: { left: 20, right: 20 }
        });
    }

    function generateDetailedReport(doc, scope, notes) {
        let students = [];
        let title = '';
        
        if (scope === 'term1') {
            students = window.term1Students.filter(s => s.studentStatus !== 'left');
            title = 'Term 1 Detailed Report';
        } else if (scope === 'term2') {
            students = window.term2Students.filter(s => s.studentStatus !== 'left');
            title = 'Term 2 Detailed Report';
        }
        
        // Header
        addPDFHeader(doc, title, notes);
        
        // Summary stats
        addSummaryStats(doc, students, scope);
        
        // Student table
        addStudentTable(doc, students, scope);
        
        // Footer
        addPDFFooter(doc);
    }

    function generateOutstandingReport(doc, scope, notes) {
        let allStudents = [];
        let title = '';
        
        if (scope === 'term1') {
            allStudents = window.term1Students;
            title = 'Term 1 Outstanding Fees Report';
        } else if (scope === 'term2') {
            allStudents = window.term2Students;
            title = 'Term 2 Outstanding Fees Report';
        } else {
            allStudents = [...window.term1Students, ...window.term2Students];
            title = 'Outstanding Fees Report - Complete Year';
        }
        
        const outstandingStudents = allStudents.filter(s => {
            const outstanding = getOutstandingAmount(s, s.term || 'term1');
            return outstanding > 0 && s.studentStatus !== 'left';
        });
        
        // Sort by year group
        const sortedStudents = sortStudentsByYear(outstandingStudents);
        
        addPDFHeader(doc, title, notes);
        
        if (sortedStudents.length === 0) {
            doc.setFontSize(16);
            doc.setTextColor(52, 199, 89);
            doc.text('ðŸŽ‰ Excellent! No outstanding fees found!', 148, 100, { align: 'center' });
            doc.setFontSize(14);
            doc.setTextColor(60, 60, 60);
            doc.text('All active students have paid their fees in full.', 148, 120, { align: 'center' });
            addPDFFooter(doc);
            return;
        }
        
        // Summary stats
        let yPos = 55;
        const totalOutstanding = sortedStudents.reduce((sum, s) => sum + getOutstandingAmount(s, s.term || 'term1'), 0);
        
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(25, yPos, 247, 32, 3, 3, 'F');
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('OUTSTANDING FEES SUMMARY', 148, yPos + 12, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Students with outstanding fees: ${sortedStudents.length}`, 35, yPos + 22);
        doc.setTextColor(255, 59, 48);
        doc.setFont(undefined, 'bold');
        doc.text(`Total Outstanding: ${formatCurrency(totalOutstanding)}`, 200, yPos + 22);
        doc.setTextColor(60, 60, 60);
        doc.setFont(undefined, 'normal');
        
        // Students table with empty NOTES column for manual writing
        yPos = 95;
        const tableData = sortedStudents.map(student => {
            const outstanding = getOutstandingAmount(student, student.term || 'term1');
            const totalFee = (parseFloat(student.setFee) || 0) + (parseFloat(student.vat) || 0);
            const paid = getTotalPaid(student);
            
            return [
                `${student.firstName} ${student.lastName}`,
                `Year ${student.year}`,
                student.term === 'term1' ? 'Term 1' : 'Term 2',
                formatCurrency(totalFee),
                formatCurrency(paid),
                formatCurrency(outstanding),
                '' // Empty notes column for manual writing
            ];
        });
        
        doc.autoTable({
            startY: yPos,
            head: [['Student Name', 'Year', 'Term', 'Total Fee', 'Paid', 'Outstanding', 'Notes']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
                fillColor: [255, 59, 48],
                textColor: [255, 255, 255],
                fontSize: 9,
                fontStyle: 'bold',
                cellPadding: 3
            },
            bodyStyles: { 
                fontSize: 8,
                cellPadding: 2.5
            },
            columnStyles: {
                0: { cellWidth: 38, fontStyle: 'bold' },
                1: { cellWidth: 18, halign: 'center' },
                2: { cellWidth: 18, halign: 'center' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 25, halign: 'right', textColor: [52, 199, 89], fontStyle: 'bold' },
                5: { cellWidth: 28, halign: 'right', textColor: [255, 59, 48], fontStyle: 'bold' },
                6: { cellWidth: 32, halign: 'left' } // Empty notes column
            },
            margin: { left: 20, right: 20 }
        });
        
        addPDFFooter(doc);
    }

    // New function to handle outstanding report generation with format selection
    function handleOutstandingReportFormat(scope) {  // â† CHANGED NAME
        const formatRadios = document.querySelectorAll('input[name="reportFormat"]');
        let selectedFormat = 'pdf';
        
        formatRadios.forEach(radio => {
            if (radio.checked) {
                selectedFormat = radio.value;
            }
        });
        
        closeModal('outstandingOptionsModal');
        
        if (selectedFormat === 'excel') {
            exportOutstandingToExcel(scope);
        } else {
            exportPDFReport(scope, 'outstanding');  // Now this is safe!
        }
    }

    function exportOutstandingToExcel(scope) {
        // Check if XLSX library is loaded
        if (typeof XLSX === 'undefined') {
            alert('Excel library not loaded. Please refresh the page and try again.');
            return;
        }
        
        let allStudents = [];
        let reportTitle = '';
        
        if (scope === 'term1') {
            allStudents = window.term1Students;
            reportTitle = 'Term 1 Outstanding Fees Report';
        } else if (scope === 'term2') {
            allStudents = window.term2Students;
            reportTitle = 'Term 2 Outstanding Fees Report';
        } else {
            allStudents = [...window.term1Students, ...window.term2Students];
            reportTitle = 'Outstanding Fees Report - Complete Year';
        }
        
        // Filter for students with outstanding fees
        const outstandingStudents = allStudents.filter(s => {
            const outstanding = getOutstandingAmount(s, s.term || 'term1');
            return outstanding > 0 && s.studentStatus !== 'left';
        });
        
        // Sort by year group
        const sortedStudents = sortStudentsByYear(outstandingStudents);
        
        if (sortedStudents.length === 0) {
            alert('No outstanding fees found! All active students have paid their fees in full.');
            return;
        }
        
        // Prepare data for Excel
        const worksheetData = [];
        
        // Add header rows
        worksheetData.push([reportTitle]);
        worksheetData.push([`Academic Year: ${currentAcademicYear}`]);
        worksheetData.push([`Generated: ${formatDateToUK(new Date())}`]);
        worksheetData.push([]); // Empty row
        
        // Add summary
        const totalOutstanding = sortedStudents.reduce((sum, s) => 
            sum + getOutstandingAmount(s, s.term || 'term1'), 0
        );
        worksheetData.push(['SUMMARY']);
        worksheetData.push(['Students with Outstanding Fees:', sortedStudents.length]);
        worksheetData.push(['Total Outstanding Amount:', formatCurrency(totalOutstanding)]);
        worksheetData.push([]); // Empty row
        
        // Add column headers
        worksheetData.push([
            'Student Name',
            'Year Group',
            'Term',
            'Date of Birth',
            'Set Fee',
            'VAT',
            'Total Fee',
            'Amount Paid',
            'Outstanding',
            'Percentage Paid',
            'Last Payment Date',
            'Contact Notes'
        ]);
        
        // Add student data
        sortedStudents.forEach(student => {
            const setFee = parseFloat(student.setFee) || 0;
            const vat = parseFloat(student.vat) || 0;
            const totalFee = setFee + vat;
            const discount = calculateDiscount(student);
            const discountedFee = totalFee - discount;
            const paid = getTotalPaid(student);
            const outstanding = getOutstandingAmount(student, student.term || 'term1');
            const percentagePaid = discountedFee > 0 ? ((paid / discountedFee) * 100).toFixed(1) : 0;
            
            // Find last payment date
            const payments = student.payments || [];
            let lastPaymentDate = 'No payments';
            if (payments.length > 0) {
                const sortedPayments = [...payments].sort((a, b) => {
                    const dateA = parseUKDateToISO(a.date);
                    const dateB = parseUKDateToISO(b.date);
                    return dateB.localeCompare(dateA);
                });
                lastPaymentDate = formatDateToUK(sortedPayments[0].date);
            }
            
            worksheetData.push([
                `${student.firstName} ${student.lastName}`,
                `Year ${student.year}`,
                student.term === 'term1' ? 'Term 1' : 'Term 2',
                formatDateToUK(student.dob),
                setFee,  // Keep as number for Excel formatting
                vat,     // Keep as number for Excel formatting
                totalFee, // Keep as number for Excel formatting
                paid,    // Keep as number for Excel formatting
                outstanding, // Keep as number for Excel formatting
                `${percentagePaid}%`,
                lastPaymentDate,
                '' // Empty column for manual notes
            ]);
        });
        
        // Add totals
        worksheetData.push([]); // Empty row
        worksheetData.push([]); // Empty row
        
        const totalSetFees = sortedStudents.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0), 0);
        const totalVAT = sortedStudents.reduce((sum, s) => sum + (parseFloat(s.vat) || 0), 0);
        const totalFees = totalSetFees + totalVAT;
        const totalPaid = sortedStudents.reduce((sum, s) => sum + getTotalPaid(s), 0);
        
        worksheetData.push([
            'GRAND TOTAL',
            `${sortedStudents.length} students`,
            '',
            '',
            totalSetFees,
            totalVAT,
            totalFees,
            totalPaid,
            totalOutstanding,
            '',
            '',
            ''
        ]);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        
        // Set column widths
        ws['!cols'] = [
            { width: 30 }, // Student Name
            { width: 12 }, // Year Group
            { width: 10 }, // Term
            { width: 15 }, // Date of Birth
            { width: 12 }, // Set Fee
            { width: 10 }, // VAT
            { width: 12 }, // Total Fee
            { width: 12 }, // Amount Paid
            { width: 15 }, // Outstanding
            { width: 15 }, // Percentage Paid
            { width: 18 }, // Last Payment Date
            { width: 35 }  // Contact Notes
        ];
        
        // Apply number formatting to currency columns (E through I)
        const range = XLSX.utils.decode_range(ws['!ref']);
        for(let R = 9; R <= range.e.r; ++R) {  // Start from row 10 (data rows)
            ['E', 'F', 'G', 'H', 'I'].forEach(col => {
                const address = col + (R + 1);
                if(ws[address] && typeof ws[address].v === 'number') {
                    ws[address].z = 'Â£#,##0.00';  // Excel currency format
                }
            });
        }
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Outstanding Fees');
        
        // Generate filename
        const timestamp = formatDateToUK(new Date()).replace(/\//g, '-');
        const filename = `Outstanding_Report_${scope}_${currentAcademicYear}_${timestamp}.xlsx`;
        
        // Save the file
        XLSX.writeFile(wb, filename);
        
        // Show success message
        setTimeout(() => {
            alert(`Excel report generated successfully!\n\nFile: ${filename}\n\nThe file will open with proper formatting in Microsoft Excel.`);
        }, 500);
    }

    function generateVATReport(doc, notes) {
        addPDFHeader(doc, 'VAT Summary Report', notes);
        
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        
        let yPos = 60;
        
        // Calculate VAT figures
        const totalVATSet = activeStudents.reduce((sum, s) => sum + (parseFloat(s.vat) || 0), 0);
        const vatCollected = activeStudents.reduce((sum, s) => {
            const payments = s.payments || [];
            const totalPaid = payments.reduce((pSum, p) => pSum + (parseFloat(p.amount) || 0), 0);
            const setFee = parseFloat(s.setFee) || 0;
            const vatAmount = parseFloat(s.vat) || 0;
            
            if (vatAmount <= 0) return sum;
            
            if (totalPaid <= setFee) {
                return sum;
            } else {
                const excessPayment = totalPaid - setFee;
                const vatCollectedForStudent = Math.min(excessPayment, vatAmount);
                return sum + vatCollectedForStudent;
            }
        }, 0);
        const vatOutstanding = totalVATSet - vatCollected;
        
        // VAT Summary Cards
        doc.setFillColor(99, 102, 241);
        doc.rect(20, yPos, 60, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Total VAT Set', 50, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(totalVATSet), 50, yPos + 30, { align: 'center' });
        
        doc.setFillColor(52, 199, 89);
        doc.rect(88, yPos, 60, 40, 'F');
        doc.setFontSize(12);
        doc.text('VAT Collected', 118, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(vatCollected), 118, yPos + 30, { align: 'center' });
        
        doc.setFillColor(255, 149, 0);
        doc.rect(156, yPos, 60, 40, 'F');
        doc.setFontSize(12);
        doc.text('VAT Outstanding', 186, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(vatOutstanding), 186, yPos + 30, { align: 'center' });
        
        doc.setFillColor(239, 68, 68);
        doc.rect(224, yPos, 52, 40, 'F');
        doc.setFontSize(12);
        doc.text('VAT Liability', 250, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(totalVATSet), 250, yPos + 30, { align: 'center' });
        
        addPDFFooter(doc);
    }

    function generateSummaryReport(doc, notes) {
        addPDFHeader(doc, 'Financial Summary Report', notes);
        
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        
        // Financial overview cards
        let yPos = 60;
        const totalRevenue = activeStudents.reduce((sum, s) => sum + getTotalPaid(s), 0);
        const totalOutstanding = activeStudents.reduce((sum, s) => sum + getOutstandingAmount(s, s.term || 'term1'), 0);
        const totalFees = activeStudents.reduce((sum, s) => sum + (parseFloat(s.setFee) || 0) + (parseFloat(s.vat) || 0), 0);
        const collectionRate = totalFees > 0 ? (totalRevenue / totalFees * 100) : 0;
        
        // Revenue card
        doc.setFillColor(52, 199, 89);
        doc.rect(20, yPos, 60, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Total Revenue', 50, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(totalRevenue), 50, yPos + 30, { align: 'center' });
        
        // Outstanding card
        doc.setFillColor(255, 59, 48);
        doc.rect(88, yPos, 60, 40, 'F');
        doc.setFontSize(12);
        doc.text('Outstanding', 118, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(totalOutstanding), 118, yPos + 30, { align: 'center' });
        
        // Collection Rate card
        doc.setFillColor(99, 102, 241);
        doc.rect(156, yPos, 60, 40, 'F');
        doc.setFontSize(12);
        doc.text('Collection Rate', 186, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(`${collectionRate.toFixed(1)}%`, 186, yPos + 30, { align: 'center' });
        
        // Total Fees card
        doc.setFillColor(16, 163, 127);
        doc.rect(224, yPos, 52, 40, 'F');
        doc.setFontSize(12);
        doc.text('Total Fees', 250, yPos + 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(formatCurrency(totalFees), 250, yPos + 30, { align: 'center' });
        
        // Term breakdown
        yPos = 120;
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('Term Breakdown', 25, yPos);
        
        const term1Students = window.term1Students.filter(s => s.studentStatus !== 'left');
        const term2Students = window.term2Students.filter(s => s.studentStatus !== 'left');
        
        const term1Revenue = term1Students.reduce((sum, s) => sum + getTotalPaid(s), 0);
        const term1Outstanding = term1Students.reduce((sum, s) => sum + getOutstandingAmount(s, 'term1'), 0);
        const term2Revenue = term2Students.reduce((sum, s) => sum + getTotalPaid(s), 0);
        const term2Outstanding = term2Students.reduce((sum, s) => sum + getOutstandingAmount(s, 'term2'), 0);
        
        yPos = 140;
        const termData = [
            ['Term 1', term1Students.length, formatCurrency(term1Revenue), formatCurrency(term1Outstanding)],
            ['Term 2', term2Students.length, formatCurrency(term2Revenue), formatCurrency(term2Outstanding)],
            ['TOTAL', activeStudents.length, formatCurrency(totalRevenue), formatCurrency(totalOutstanding)]
        ];
        
        doc.autoTable({
            startY: yPos,
            head: [['Term', 'Students', 'Revenue', 'Outstanding']],
            body: termData,
            theme: 'grid',
            headStyles: { 
                fillColor: [16, 163, 127],
                textColor: [255, 255, 255],
                fontSize: 11,
                fontStyle: 'bold',
                cellPadding: 4
            },
            bodyStyles: { 
                fontSize: 10,
                cellPadding: 5
            },
            columnStyles: {
                0: { cellWidth: 50, fontStyle: 'bold' },
                1: { cellWidth: 50, halign: 'center' },
                2: { cellWidth: 60, halign: 'right', textColor: [52, 199, 89], fontStyle: 'bold' },
                3: { cellWidth: 60, halign: 'right', textColor: [255, 59, 48], fontStyle: 'bold' }
            },
            margin: { left: 20, right: 20 }
        });
        
        addPDFFooter(doc);
    }

    function generatePaymentMethodsReport(doc, notes) {
        addPDFHeader(doc, 'Payment Methods Analysis', notes);
        
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        const allPayments = activeStudents.flatMap(s => s.payments || []);
        
        if (allPayments.length === 0) {
            doc.setFontSize(16);
            doc.setTextColor(255, 149, 0);
            doc.text('No payment data available for analysis.', 148, 100, { align: 'center' });
            addPDFFooter(doc);
            return;
        }
        
        // Payment method breakdown
        const paymentMethods = {};
        let totalAmount = 0;
        
        allPayments.forEach(payment => {
            const method = payment.method || 'Not Specified';
            const amount = parseFloat(payment.amount) || 0;
            
            if (!paymentMethods[method]) {
                paymentMethods[method] = { count: 0, amount: 0 };
            }
            paymentMethods[method].count++;
            paymentMethods[method].amount += amount;
            totalAmount += amount;
        });
        
        // Summary
        let yPos = 60;
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(25, yPos, 247, 25, 3, 3, 'F');
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('PAYMENT METHODS SUMMARY', 148, yPos + 10, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Payments: ${allPayments.length}`, 35, yPos + 20);
        doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 200, yPos + 20);
        
        // Payment methods table
        yPos = 100;
        const methodData = Object.entries(paymentMethods)
            .sort(([,a], [,b]) => b.amount - a.amount)
            .map(([method, data]) => {
                const percentage = totalAmount > 0 ? (data.amount / totalAmount * 100) : 0;
                return [
                    method,
                    data.count.toString(),
                    formatCurrency(data.amount),
                    `${percentage.toFixed(1)}%`
                ];
            });
        
        doc.autoTable({
            startY: yPos,
            head: [['Payment Method', 'Count', 'Total Amount', 'Percentage']],
            body: methodData,
            theme: 'grid',
            headStyles: { 
                fillColor: [99, 102, 241],
                textColor: [255, 255, 255],
                fontSize: 11,
                fontStyle: 'bold',
                cellPadding: 4
            },
            bodyStyles: { 
                fontSize: 10,
                cellPadding: 5
            },
            columnStyles: {
                0: { cellWidth: 70, fontStyle: 'bold' },
                1: { cellWidth: 40, halign: 'center' },
                2: { cellWidth: 50, halign: 'right', textColor: [52, 199, 89], fontStyle: 'bold' },
                3: { cellWidth: 40, halign: 'right', textColor: [99, 102, 241], fontStyle: 'bold' }
            },
            margin: { left: 20, right: 20 }
        });
        
        addPDFFooter(doc);
    }

    function generateYearGroupsReport(doc, notes) {
        addPDFHeader(doc, 'Year Group Analysis', notes);
        
        const allStudents = [...window.term1Students, ...window.term2Students];
        const activeStudents = allStudents.filter(s => s.studentStatus !== 'left');
        
        if (activeStudents.length === 0) {
            doc.setFontSize(16);
            doc.setTextColor(255, 149, 0);
            doc.text('No active students found for analysis.', 148, 100, { align: 'center' });
            addPDFFooter(doc);
            return;
        }
        
        // Year group breakdown
        const yearGroups = {};
        
        activeStudents.forEach(student => {
            const year = student.year || 'Unknown';
            const outstanding = getOutstandingAmount(student, student.term || 'term1');
            const paid = getTotalPaid(student);
            const totalFee = (parseFloat(student.setFee) || 0) + (parseFloat(student.vat) || 0);
            
            if (!yearGroups[year]) {
                yearGroups[year] = {
                    count: 0,
                    totalFees: 0,
                    totalPaid: 0,
                    totalOutstanding: 0
                };
            }
            
            yearGroups[year].count++;
            yearGroups[year].totalFees += totalFee;
            yearGroups[year].totalPaid += paid;
            yearGroups[year].totalOutstanding += outstanding;
        });
        
        // Summary
        let yPos = 60;
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(25, yPos, 247, 25, 3, 3, 'F');
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('YEAR GROUP DISTRIBUTION', 148, yPos + 10, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Active Students: ${activeStudents.length}`, 35, yPos + 20);
        doc.text(`Year Groups: ${Object.keys(yearGroups).length}`, 200, yPos + 20);
        
        // Sort year groups by order (7, 8, 9, 10, 11, 16+, 18+, 19+)
        const sortedYearGroups = Object.entries(yearGroups).sort(([a], [b]) => {
            return getYearGroupOrder(a) - getYearGroupOrder(b);
        });
        
        // Year groups table
        yPos = 100;
        const yearData = sortedYearGroups.map(([year, data]) => {
            const collectionRate = data.totalFees > 0 ? (data.totalPaid / data.totalFees * 100) : 0;
            return [
                `Year ${year}`,
                data.count.toString(),
                formatCurrency(data.totalFees),
                formatCurrency(data.totalPaid),
                formatCurrency(data.totalOutstanding),
                `${collectionRate.toFixed(1)}%`
            ];
        });
        
        doc.autoTable({
            startY: yPos,
            head: [['Year Group', 'Students', 'Total Fees', 'Collected', 'Outstanding', 'Collection Rate']],
            body: yearData,
            theme: 'grid',
            headStyles: { 
                fillColor: [175, 82, 222],
                textColor: [255, 255, 255],
                fontSize: 9,
                fontStyle: 'bold',
                cellPadding: 3
            },
            bodyStyles: { 
                fontSize: 8,
                cellPadding: 2.5
            },
            columnStyles: {
                0: { cellWidth: 32, fontStyle: 'bold' },
                1: { cellWidth: 23, halign: 'center' },
                2: { cellWidth: 32, halign: 'right' },
                3: { cellWidth: 32, halign: 'right', textColor: [52, 199, 89], fontStyle: 'bold' },
                4: { cellWidth: 32, halign: 'right', textColor: [255, 59, 48], fontStyle: 'bold' },
                5: { cellWidth: 32, halign: 'right', textColor: [99, 102, 241], fontStyle: 'bold' }
            },
            margin: { left: 20, right: 20 }
        });
        
        addPDFFooter(doc);
    }

    // Make functions globally accessible for onclick handlers
    window.switchView = switchView;
    window.showAddStudent = showAddStudent;
    window.viewStudent = viewStudent;
    window.showAddPayment = showAddPayment;
    window.savePayment = savePayment;
    window.editStudent = editStudent;
    window.editStudentFromView = editStudentFromView;
    window.deleteStudent = deleteStudent;
    window.deletePayment = deletePayment;
    window.closeModal = closeModal;
    window.addPaymentEntry = addPaymentEntry;
    window.removePaymentEntry = removePaymentEntry;
    window.saveStudent = saveStudent;
    window.manualSync = manualSync;
    window.applyFilter = applyFilter;
    window.showImportModal = showImportModal;
    window.handleCSVUpload = handleCSVUpload;
    window.processCSVImport = processCSVImport;
    window.exportPDFReport = exportPDFReport;
    window.updateAnalytics = updateAnalytics;
    window.showYearSelector = showYearSelector;
    window.confirmYearChange = confirmYearChange;
    window.changeAcademicYear = changeAcademicYear;
    window.exportToCSV = exportToCSV;
    window.showImportCSV = showImportCSV;
    window.showOutstandingReportOptions = showOutstandingReportOptions;
    window.handleOutstandingReportFormat = handleOutstandingReportFormat;
    window.exportOutstandingToExcel = exportOutstandingToExcel;
    
    // Bulk selection functions
    window.toggleStudentSelection = toggleStudentSelection;
    window.toggleSelectAll = toggleSelectAll;
    window.selectAllStudents = selectAllStudents;
    window.deselectAllStudents = deselectAllStudents;
    window.bulkDeleteStudents = bulkDeleteStudents;
    
    // Date formatting functions
    window.autoFormatDate = autoFormatDate;
    window.showDatePicker = showDatePicker;
    </script>
</body>
</html>
